# Миграция данных из бекапа Бедолага

## Описание

Скрипт `migrate_from_bedolaga.py` позволяет мигрировать данные из бекапа бота "Бедолага" в базу данных STEALTHNET-Panel.

## Использование

### Локальный запуск (без Docker)

```bash
python migration/migrate_from_bedolaga.py /path/to/backup_20260126_000000
```

### Запуск в Docker (рекомендуется)

См. подробную инструкцию: [DOCKER_MIGRATION.md](DOCKER_MIGRATION.md)

**Быстрый старт:**
```bash
./migration/run_migration_docker.sh /path/to/backup_20260126_000000
```

## Использование (локально)

```bash
python migration/migrate_from_bedolaga.py /path/to/backup_20260126_000000
```

### Параметры

- `backup_path` - Путь к папке с бекапом (обязательный)
- `--force` - Перезаписать существующую базу данных без подтверждения

### Примеры

```bash
# Базовая миграция
python migration/migrate_from_bedolaga.py backup_20260126_000000

# Миграция с перезаписью существующей базы
python migration/migrate_from_bedolaga.py backup_20260126_000000 --force
```

## Что мигрируется

### ✅ Мигрируется:

1. **Пользователи (users)**
   - Telegram ID и username
   - RemnaWave UUID
   - Реферальный код
   - Баланс (конвертируется из копеек в рубли)
   - Язык
   - Статус использования триала
   - Реферальные связи

2. **Конфиги пользователей (UserConfig)**
   - Создаются из подписок и пользователей с remnawave_uuid
   - Связываются с пользователями

3. **Платежи (Payment)**
   - Все транзакции (пополнения и оплаты подписок)
   - Статусы и провайдеры платежей
   - Суммы (конвертируются из копеек в рубли)

4. **Тикеты поддержки (Ticket, TicketMessage)**
   - Все тикеты и сообщения
   - Статусы тикетов
   - Информация об отправителях

### ⚠️ Не мигрируется:

- Системные настройки (структура отличается)
- Промокоды (нужно настроить вручную)
- Тарифы (нужно создать вручную)
- Настройки бота

## Результат

После успешной миграции создается файл:
```
instance/stealthnet.db
```

## Важные замечания

1. **ID пользователей изменяются** - старые ID из Бедолага не сохраняются, создается маппинг для связей
2. **Балансы конвертируются** - из копеек в рубли (деление на 100)
3. **Валюта по умолчанию** - все платежи мигрируются с валютой 'rub'
4. **Проверка дубликатов** - если пользователь с таким telegram_id уже существует, он пропускается

## После миграции

1. Проверьте базу данных через админ-панель
2. Настройте системные настройки вручную
3. Создайте тарифы для пользователей (если нужно)
4. Настройте платежные системы
5. Проверьте связи пользователей с RemnaWave

## Устранение проблем

### Ошибка "ModuleNotFoundError: No module named 'flask'"
Убедитесь, что вы используете правильное виртуальное окружение или установлены все зависимости:
```bash
pip install -r requirements.txt
```

### Ошибка "Файл database.json не найден"
Проверьте, что путь к бекапу указан правильно и в папке есть файл `database.json`.

### Пользователи не мигрируются
Проверьте, что в бекапе есть таблица `users` с данными. Убедитесь, что у пользователей есть `telegram_id`.
