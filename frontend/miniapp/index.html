<!DOCTYPE html>
<!-- design: STELS-style v2 -->
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a2234">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>VPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --tg-theme-bg-color: #fafbfc;
            --tg-theme-text-color: #0f0f12;
            --tg-theme-hint-color: #6b7280;
            --tg-theme-link-color: #6366f1;
            --tg-theme-button-color: #6366f1;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f3f4f6;
            
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --primary-dark: #4f46e5;
            --primary-hover: #818cf8;
            --secondary: #a855f7;
            --accent: #06b6d4;
            --accent-purple: #a855f7;
            
            --text-primary: #0f0f12;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            
            --bg-primary: #fafbfc;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #e5e7eb;
            --body-bg: linear-gradient(160deg, #fafbfc 0%, #f0f1ff 50%, #e8f4ff 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.06);
            --glass-blur: saturate(180%) blur(20px);
            --glass-edge: rgba(255, 255, 255, 0.9);
            --bg-glass: var(--glass-bg);
            
            --border-color: var(--glass-border);
            --border-glow: rgba(99, 102, 241, 0.4);
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
            
            --radius-sm: 10px;
            --radius: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            --bento-radius: 16px;
            --bento-radius-lg: 20px;
            
            --success: #10b981;
            --accent-green: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            
            --surface-muted: rgba(0, 0, 0, 0.03);
            --surface-strong: rgba(99, 102, 241, 0.08);
            --gradient-primary: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.08) 100%);
            --gradient-card: linear-gradient(145deg, rgba(99, 102, 241, 0.06) 0%, rgba(6, 182, 212, 0.04) 100%);
        }

        :root[data-theme="light"] {
            color-scheme: light;
        }

        :root[data-theme="dark"] {
            color-scheme: dark;
            /* Тёмная тема — светлее: серо-синий фон вместо почти чёрного */
            --color-dark-50: 248, 250, 252;
            --color-dark-100: 241, 245, 249;
            --color-dark-400: 148, 163, 184;
            --color-dark-500: 100, 116, 139;
            --color-dark-700: 51, 65, 85;
            --color-dark-900: 15, 23, 42;
            --color-dark-950: 10, 15, 26;
            --color-accent-400: 96, 165, 250;
            --color-accent-500: 59, 130, 246;
            --tg-theme-bg-color: #1a2234;
            --tg-theme-text-color: #f1f5f9;
            --tg-theme-hint-color: #94a3b8;
            --tg-theme-link-color: #60a5fa;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #243044;
            --bento-radius: 16px;
            --bento-radius-lg: 24px;
            --bento-padding: 20px;
            
            --primary: #60a5fa;
            --primary-rgb: 59, 130, 246;
            --primary-glow: rgba(59, 130, 246, 0.3);
            --primary-dark: #2563eb;
            --primary-hover: #93c5fd;
            --secondary: #818cf8;
            --accent: #60a5fa;
            --accent-purple: #a78bfa;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --bg-primary: #1a2234;
            --bg-secondary: #243044;
            --bg-tertiary: #2d3a52;
            --body-bg: #1a2234;
            
            --glass-bg: rgba(36, 48, 68, 0.45);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px);
            --glass-edge: rgba(255, 255, 255, 0.12);
            --bg-glass: var(--glass-bg);
            
            --border-color: rgba(71, 85, 105, 0.35);
            --border-glow: rgba(59, 130, 246, 0.3);
            
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.35);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.15);
            
            --success: #22c55e;
            --accent-green: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            
            --surface-muted: rgba(71, 85, 105, 0.2);
            --surface-strong: rgba(59, 130, 246, 0.12);
            --tariff-card-bg: rgba(36, 48, 68, 0.9);
            --tariff-card-border: rgba(71, 85, 105, 0.35);
            --gradient-primary: rgba(59, 130, 246, 0.1);
            --gradient-card: rgba(36, 48, 68, 0.85);
        }

        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--body-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            letter-spacing: -0.01em;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            opacity: 0.04;
            mix-blend-mode: overlay;
        }
        :root[data-theme="dark"] body {
            background: 
                radial-gradient(ellipse 120% 80% at 50% -20%, rgba(99, 102, 246, 0.18), transparent 45%),
                radial-gradient(ellipse 90% 70% at 95% 90%, rgba(139, 92, 246, 0.12), transparent 45%),
                radial-gradient(ellipse 70% 90% at 5% 85%, rgba(59, 130, 246, 0.1), transparent 45%),
                radial-gradient(ellipse 60% 60% at 50% 50%, rgba(88, 80, 236, 0.06), transparent 50%),
                #1a2234;
        }
        :root[data-theme="dark"] body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background-image: 
                radial-gradient(1.5px 1.5px at 15px 25px, rgba(255,255,255,0.55), transparent),
                radial-gradient(1px 1px at 80px 60px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 140px 15px, rgba(255,255,255,0.35), transparent),
                radial-gradient(1.5px 1.5px at 200px 90px, rgba(255,255,255,0.45), transparent),
                radial-gradient(1px 1px at 270px 140px, rgba(255,255,255,0.35), transparent),
                radial-gradient(1.5px 1.5px at 50px 160px, rgba(255,255,255,0.4), transparent),
                radial-gradient(1px 1px at 180px 200px, rgba(255,255,255,0.3), transparent);
            background-size: 300px 220px;
            opacity: 0.55;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 16px;
            padding-bottom: 110px;
            position: relative;
            z-index: 1;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            gap: 24px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--surface-muted);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.3); }
            50% { box-shadow: 0 0 40px rgba(var(--primary-rgb), 0.5); }
        }

        /* SVG Icons */
        .icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .icon-sm { width: 16px; height: 16px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 28px; height: 28px; }

        .icon-filled {
            fill: currentColor;
            stroke: none;
        }

        /* Карточки — стекло (glassmorphism) */
        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--bento-radius);
            padding: var(--bento-padding, 20px);
            margin-bottom: 16px;
            box-shadow: 
                inset 0 1px 0 0 var(--glass-edge),
                0 4px 24px rgba(0, 0, 0, 0.12);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            animation: fadeIn 0.4s ease;
        }
        :root[data-theme="dark"] .card {
            box-shadow: 
                inset 0 1px 0 0 var(--glass-edge),
                0 8px 32px rgba(0, 0, 0, 0.25);
        }

        .card:hover {
            border-color: var(--glass-border);
            box-shadow: 
                inset 0 1px 0 0 var(--glass-edge),
                0 8px 32px rgba(0, 0, 0, 0.18);
        }
        :root[data-theme="dark"] .card:hover {
            box-shadow: 
                inset 0 1px 0 0 var(--glass-edge),
                0 12px 40px rgba(0, 0, 0, 0.35);
        }
        
        .card-hero {
            position: relative;
            overflow: hidden;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 
                inset 0 1px 0 0 var(--glass-edge),
                0 4px 24px rgba(0, 0, 0, 0.12);
        }
        :root[data-theme="dark"] .card-hero {
            box-shadow: 
                inset 0 1px 0 0 var(--glass-edge),
                0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        .card-hero::before {
            display: none;
        }
        
        .card-hero > * {
            position: relative;
            z-index: 1;
        }
        
        .gradient-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 1px 0 0 var(--glass-edge);
        }
        
        .accent-card {
            background: rgba(59, 130, 246, 0.12);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .softer-card {
            background: var(--glass-bg);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.02em;
        }

        .card-title .icon {
            color: var(--primary);
        }
        
        .widget-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.02em;
        }

        .widget-title .icon {
            color: var(--primary);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            border: 1px solid transparent;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.online {
            background: var(--accent-green);
            box-shadow: 0 0 12px var(--accent-green);
        }

        .status-dot.offline {
            background: var(--accent-red);
            box-shadow: 0 0 12px var(--accent-red);
            animation: none;
        }

        /* Info Items */
        .info-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface-muted);
            border-radius: var(--bento-radius);
            border: 1px solid transparent;
            transition: background 0.2s ease;
        }

        .info-item:hover {
            background: var(--surface-strong);
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-label .icon {
            color: var(--text-muted);
        }

        .info-value {
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Profile: compact login data (wrap long email/password) */
        .login-info-grid .info-item {
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            gap: 6px;
        }

        .login-info-grid .info-label {
            font-size: 13px;
        }

        .login-info-grid .info-value {
            width: 100%;
            text-align: left;
            font-size: 13px;
            line-height: 1.25;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .info-value.success {
            color: var(--accent-green);
        }

        .info-value.warning {
            color: var(--warning);
        }

        /* Old style support */
        .info-list.modern {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 16px;
        }
        
        .info-item.modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface-muted);
            border-radius: var(--radius);
            border: none;
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            width: 100%;
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-muted);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            box-shadow: none;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--surface-strong);
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            margin: 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Inputs */
        .input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            background: var(--surface-muted);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
            outline: none;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
            background: var(--bg-secondary);
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .input {
            flex: 1;
            min-width: 0;
        }

        .input-group .btn {
            flex-shrink: 0;
            width: auto;
            margin: 0;
            padding: 14px 20px;
        }

        /* Old input-with-button support */
        .input-with-button {
            display: flex;
            align-items: stretch;
            gap: 10px;
            width: 100%;
        }

        .input-with-button input {
            flex: 1;
            min-width: 0;
            padding: 14px 18px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            background: var(--surface-muted);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
            outline: none;
        }

        .input-with-button input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        .input-with-button button {
            flex-shrink: 0;
            margin: 0;
            width: auto;
            min-width: 60px;
        }

        /* Select */
        .select {
            width: 100%;
            padding: 14px 18px;
            padding-right: 44px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            background: var(--surface-muted);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            transition: all 0.2s ease;
            outline: none;
        }

        .select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        /* Tariff Cards */
        .tariff-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Tariff accordion */
        .tariff-accordion {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .tariff-accordion-header {
            width: 100%;
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            text-align: left;
        }

        .tariff-accordion-header:hover {
            border-color: rgba(var(--primary-rgb), 0.25);
            background: var(--surface-strong);
        }

        .tariff-accordion.open .tariff-accordion-header {
            border-color: var(--primary);
            background: var(--surface-strong);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.08);
        }

        .tariff-accordion-title {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .tariff-accordion-title span {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tariff-accordion-meta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .tariff-accordion-chevron {
            width: 18px;
            height: 18px;
            transition: transform 0.2s ease;
            opacity: 0.9;
        }

        .tariff-accordion.open .tariff-accordion-chevron {
            transform: rotate(180deg);
        }

        .tariff-accordion-body {
            display: none;
            padding: 0 2px;
        }

        .tariff-accordion.open .tariff-accordion-body {
            display: block;
        }

        .tariff-features-box {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .tariff-features-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .tariff-features-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tariff-feature-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.35;
        }

        .tariff-feature-item .ff-icon {
            width: 18px;
            flex-shrink: 0;
            color: var(--primary);
            margin-top: 1px;
        }

        @media (max-width: 360px) {
            .tariff-accordion-header {
                padding: 10px 12px;
            }
            .tariff-accordion-meta {
                gap: 6px;
            }
        }

        .tariff-card {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Стили для карточки tier (заголовок аккордеона) */
        .tariff-accordion-header {
            background: #f5f5f0 !important;
        }
        
        :root[data-theme="dark"] .tariff-accordion-header {
            background: var(--glass-bg) !important;
            border-color: var(--glass-border) !important;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }
        
        :root[data-theme="dark"] .tariff-card {
            background: var(--glass-bg) !important;
            border-color: var(--glass-border) !important;
        }
        
        :root[data-theme="dark"] .tariff-card:hover {
            background: var(--surface-strong) !important;
            border-color: rgba(var(--primary-rgb), 0.3) !important;
        }

        .tariff-card:hover {
            border-color: rgba(var(--primary-rgb), 0.3);
            background: var(--surface-strong);
            transform: translateX(4px);
        }

        .tariff-card.selected {
            border-color: var(--primary);
            background: var(--surface-strong);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
        }

        .tariff-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tariff-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .tariff-duration {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tariff-price {
            font-size: 17px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Карточка варианта тарифа (срок + цена) в модалке */
        .tariff-detail-option {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px 18px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-xs);
            margin-bottom: 0;
        }
        .tariff-detail-option:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.35);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .tariff-detail-option .option-duration {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .tariff-detail-option .option-period {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .tariff-detail-option .option-limits {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tariff-detail-option > div > div:first-child {
            min-width: 0;
        }
        .tariff-detail-option .option-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.2;
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: nowrap;
            flex-shrink: 0;
            margin-left: 12px;
        }
        .tariff-detail-option .option-price .tariff-price-old {
            font-size: 13px;
            color: var(--text-muted);
            text-decoration: line-through;
            margin-right: 6px;
        }

        .tariff-price-old {
            text-decoration: line-through;
            color: var(--text-muted);
            font-size: 0.85em;
            margin-right: 6px;
        }
        /* Цена со скидкой в основной карточке тарифа — перечёркивание и в одну строку */
        .tariff-accordion-header .tariff-price-old {
            text-decoration: line-through;
            color: var(--text-muted);
            font-size: 0.85em;
            margin-right: 6px;
        }
        .tariff-accordion-price-line {
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
            flex-wrap: nowrap;
        }
        /* Строка Трафик/Устр. — не даём перекрывать блоком цены */
        .tariff-accordion-traffic-row {
            display: flex;
            align-items: center;
            width: 100%;
            min-width: 0;
        }
        .tariff-accordion-traffic-row .tariff-accordion-devices {
            flex-shrink: 0;
            margin-left: auto;
        }
        /* Блок цены в карточке — ограничиваем ширину, чтобы не перекрывал Устр. */
        .tariff-accordion-price-block {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }
        .tariff-accordion-price-block .tariff-accordion-price-line {
            min-width: 0;
        }
        /* Верхний блок (название + Трафик/Устр.) — даём сжиматься по ширине */
        .tariff-accordion-header > div > div:first-child {
            min-width: 0;
        }
        .tariff-accordion-header .tariff-accordion-price-block + .btn {
            flex-shrink: 0;
        }

        /* Server Items */
        .server-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .server-card {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            transition: all 0.25s ease;
        }

        .server-card:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.2);
            transform: translateY(-2px);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .server-main {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .server-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .server-icon .icon {
            color: var(--primary);
        }

        .server-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .server-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .server-region {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .server-protocol {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(var(--primary-rgb), 0.15);
            color: var(--primary);
        }

        .server-status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
        }

        .server-status-badge.online {
            background: rgba(16, 185, 129, 0.12);
            color: var(--accent-green);
        }

        .server-status-badge.offline {
            background: rgba(239, 68, 68, 0.12);
            color: var(--accent-red);
        }

        .server-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .server-status-badge.online .server-status-dot {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        .server-status-badge.offline .server-status-dot {
            background: var(--accent-red);
            box-shadow: 0 0 8px var(--accent-red);
            animation: none;
        }

        .server-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .server-stat {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .server-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .server-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .server-stat-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .server-progress {
            height: 4px;
            background: var(--surface-strong);
            border-radius: 100px;
            overflow: hidden;
        }

        .server-progress-fill {
            height: 100%;
            border-radius: 100px;
            transition: width 0.4s ease;
        }

        .server-progress-fill.load {
            background: linear-gradient(90deg, var(--accent-green), var(--warning));
        }

        .server-progress-fill.load.high {
            background: linear-gradient(90deg, var(--warning), var(--accent-red));
        }

        .server-progress-fill.load.low {
            background: var(--accent-green);
        }

        /* Configs List */
        .configs-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .config-card {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            transition: all 0.25s ease;
        }

        .config-card:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.2);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .config-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .config-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .config-status.active {
            color: var(--accent-green);
        }

        .config-status.inactive {
            color: var(--text-muted);
        }

        .config-toolbar {
            display: flex;
            gap: 6px;
            margin-left: 10px;
            align-items: center;
        }

        .icon-btn {
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: var(--surface-muted);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0;
        }

        .icon-btn:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.2);
            color: var(--text-primary);
        }

        .icon-btn:active {
            transform: scale(0.96);
        }

        .icon-btn-danger {
            color: var(--accent-red);
        }

        .config-actions {
            display: grid;
            /* Всегда: 2 кнопки в ряд (Подключиться + Копировать), а "Продлить" ниже */
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Config actions: compact + consistent buttons */
        .config-actions .btn {
            width: 100%;
            margin-top: 0;
            padding: 10px 12px;
            font-size: 12px;
            border-radius: 14px;
            box-shadow: none;
            min-height: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .config-actions .btn::before {
            display: none;
        }

        .config-actions .btn:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        .config-actions .btn:active {
            transform: scale(0.99);
        }

        .config-actions .btn .icon {
            width: 16px;
            height: 16px;
        }

        .config-actions > :only-child {
            grid-column: 1 / -1;
        }

        /* "Продлить" всегда отдельной строкой на всю ширину */
        .config-actions .config-renew-btn {
            grid-column: 1 / -1;
        }

        @media (max-width: 420px) {
            .config-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 340px) {
            .config-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Subscription Progress Card */
        .subscription-progress-card {
            background: var(--gradient-card);
            border: 1px solid rgba(var(--primary-rgb), 0.15);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
        }

        .subscription-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .subscription-progress-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subscription-days {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .subscription-progress-bar {
            height: 8px;
            background: var(--surface-muted);
            border-radius: 100px;
            overflow: hidden;
        }

        .subscription-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent-purple));
            border-radius: 100px;
            transition: width 0.5s ease;
        }

        .subscription-progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), var(--accent-orange));
        }

        .subscription-progress-fill.danger {
            background: linear-gradient(90deg, var(--accent-red), var(--danger));
        }

        /* Casino wheel */
        .casino-wheel-wrap {
            position: relative;
            width: 220px;
            height: 220px;
            margin: 20px auto 24px;
        }
        .casino-wheel-pointer {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 20px solid var(--primary);
            z-index: 2;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .casino-wheel {
            position: relative;
            width: 220px;
            height: 220px;
            border-radius: 50%;
            /* Ровно 7 секторов по 360/7 градусов. Порядок от 12ч: x5, x0, x0.5, x1, x1.5, x2, x3 */
            --seg: 51.428571deg;
            background: conic-gradient(
                #6a1b9a 0deg var(--seg),
                #c62828 var(--seg) calc(2 * var(--seg)),
                #e65100 calc(2 * var(--seg)) calc(3 * var(--seg)),
                #f9a825 calc(3 * var(--seg)) calc(4 * var(--seg)),
                #558b2f calc(4 * var(--seg)) calc(5 * var(--seg)),
                #00897b calc(5 * var(--seg)) calc(6 * var(--seg)),
                #1565c0 calc(6 * var(--seg)) 360deg
            );
            border: 6px solid var(--bg-primary);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2), inset 0 0 0 2px rgba(255,255,255,0.25);
            transition: transform 0.1s linear;
            will-change: transform;
        }
        .casino-wheel::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            pointer-events: none;
            background: repeating-conic-gradient(transparent 0deg calc(360deg/7 - 0.8deg), rgba(0,0,0,0.2) calc(360deg/7 - 0.8deg) calc(360deg/7));
        }
        .casino-wheel-labels {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            pointer-events: none;
        }
        .casino-wheel-labels .casino-sector {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 32px;
            height: 32px;
            margin-left: -16px;
            margin-top: -16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
            transform-origin: 50% 50%;
        }
        /* Центры секторов: (i+0.5)*360/7 градусов от 12ч по часовой */
        .casino-wheel-labels .casino-sector[data-idx="0"] { transform: rotate(25.714deg) translateY(-72px) rotate(-25.714deg); }
        .casino-wheel-labels .casino-sector[data-idx="1"] { transform: rotate(77.143deg) translateY(-72px) rotate(-77.143deg); }
        .casino-wheel-labels .casino-sector[data-idx="2"] { transform: rotate(128.571deg) translateY(-72px) rotate(-128.571deg); }
        .casino-wheel-labels .casino-sector[data-idx="3"] { transform: rotate(180deg) translateY(-72px) rotate(-180deg); }
        .casino-wheel-labels .casino-sector[data-idx="4"] { transform: rotate(231.429deg) translateY(-72px) rotate(-231.429deg); }
        .casino-wheel-labels .casino-sector[data-idx="5"] { transform: rotate(282.857deg) translateY(-72px) rotate(-282.857deg); }
        .casino-wheel-labels .casino-sector[data-idx="6"] { transform: rotate(334.286deg) translateY(-72px) rotate(-334.286deg); }
        .casino-wheel.spinning {
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }
        .casino-wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 4px solid var(--primary);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.15);
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Legacy support */
        .server-item {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .server-item:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.2);
        }

        .server-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 12px var(--accent-green);
            animation: pulse 2s ease-in-out infinite;
        }

        .server-status.offline {
            background: var(--accent-red);
            box-shadow: 0 0 12px var(--accent-red);
            animation: none;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--surface-muted);
            border-radius: 100px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent-purple));
            border-radius: 100px;
            transition: width 0.4s ease;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 28px;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }
        
        :root[data-theme="dark"] .modal-content {
            background: rgba(26, 26, 37, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--surface-strong);
            color: var(--text-primary);
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Safe-area helpers (iOS bottom inset) */
        :root {
            --safe-bottom: 0px;
        }
        @supports (padding: env(safe-area-inset-bottom)) {
            :root {
                --safe-bottom: env(safe-area-inset-bottom);
            }
        }

        .payment-method {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .payment-method:hover {
            border-color: var(--primary);
            background: var(--surface-strong);
        }

        /* Bottom Navigation — стеклянная таблетка */
        .bottom-nav {
            position: fixed;
            left: 16px;
            right: 16px;
            bottom: calc(16px + var(--safe-bottom));
            max-width: 448px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 8px 4px;
            z-index: 1000;
            box-sizing: border-box;
            box-shadow: inset 0 1px 0 0 var(--glass-edge), var(--shadow-md);
        }
        :root[data-theme="light"] .bottom-nav {
            box-shadow: inset 0 1px 0 0 var(--glass-edge), var(--shadow-sm);
        }

        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 2px;
            box-sizing: border-box;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 4px;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.2s ease;
            color: var(--text-muted);
            flex: 1 1 0;
            min-width: 0;
            text-align: center;
            user-select: none;
            position: relative;
        }

        .nav-item:hover {
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active .nav-item-icon {
            background: var(--surface-strong);
            border-radius: 16px;
            padding: 6px 14px;
        }

        .nav-item-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .nav-item-icon .icon {
            width: 20px;
            height: 20px;
        }

        .nav-item-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.01em;
            line-height: 1.15;
            width: 100%;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
            /* Always leave room for bottom nav + safe area */
            padding-bottom: calc(110px + var(--safe-bottom)) !important;
        }

        .page.active {
            display: block;
        }

        #pageTariffs {
            padding-bottom: 80px;
        }

        /* Блок опций: группы и карточки */
        .option-group {
            margin-bottom: 20px;
        }
        .option-group:last-child {
            margin-bottom: 0;
        }
        .option-group-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 0 2px;
        }
        .option-group-header .option-group-icon {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            background: rgba(var(--primary-rgb), 0.12);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .option-group-header .option-group-icon .icon {
            width: 16px;
            height: 16px;
        }
        .option-group-header .option-group-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .option-group-header .option-group-count {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: auto;
        }
        .option-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-xs);
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .option-item:last-child {
            margin-bottom: 0;
        }
        .option-item:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.35);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .option-item-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: rgba(var(--primary-rgb), 0.12);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .option-item-icon .icon {
            width: 22px;
            height: 22px;
        }
        .option-item-body {
            flex: 1;
            min-width: 0;
        }
        .option-item-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
            line-height: 1.3;
        }
        .option-item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .option-item-price {
            font-size: 17px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
        }

        /* Mobile: prevent input+button rows from overflowing */
        @media (max-width: 420px) {
            .input-group {
                flex-wrap: wrap;
            }
            .input-group .btn {
                width: 100%;
            }
        }

        /* Узкие экраны: ещё мельче подпись, чтобы влезала */
        @media (max-width: 400px) {
            .nav-item-label {
                font-size: 10px;
            }
        }

        /* Очень узкие: подписи скрываем, только иконки */
        @media (max-width: 360px) {
            .bottom-nav-items {
                padding: 0 6px;
            }
            .nav-item {
                padding: 8px 4px;
            }
            .nav-item-label {
                display: none;
            }
        }

        /* Branding */
        .branding-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            padding: 20px 0;
            margin-bottom: 24px;
        }

        .branding-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            display: block;
            flex-shrink: 0;
            border-radius: 12px;
        }

        .branding-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
            letter-spacing: -0.03em;
        }

        .branding-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .branding-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Theme Toggle — как карточка STELS */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            width: 44px;
            height: 44px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        :root[data-theme="light"] .theme-toggle {
            box-shadow: var(--shadow-sm), inset 0 1px 0 0 rgba(0, 0, 0, 0.03);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
        }

        .theme-toggle:active {
            transform: scale(0.98);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .error { color: var(--danger); text-align: center; padding: 24px; }
        .text-warning { color: var(--warning); }
        .text-success { color: var(--accent-green); }
        .text-muted { color: var(--text-muted); }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }

        /* Dashboard — структура как у STELS */
        .dashboard-header {
            margin-bottom: 24px;
        }
        .dashboard-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            line-height: 1.2;
        }
        .dashboard-header p {
            margin-top: 4px;
            font-size: 0.9375rem;
            color: var(--text-secondary);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .bento-tile {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--bento-radius);
            padding: 20px;
            box-shadow: inset 0 1px 0 0 var(--glass-edge);
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease;
            text-align: left;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        .bento-tile:hover {
            border-color: var(--border-color);
            background: var(--bg-secondary);
        }
        .bento-tile .tile-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .bento-tile .tile-label .arrow {
            color: var(--text-muted);
            transition: color 0.2s ease;
        }
        .bento-tile:hover .tile-label .arrow {
            color: var(--primary);
        }
        .bento-tile .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .bento-tile .stat-value.accent {
            color: var(--primary);
        }
        .bento-tile .stat-value.success {
            color: var(--accent-green);
        }
        .subscription-card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px 16px;
            margin-bottom: 20px;
        }
        .subscription-card-grid .grid-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .subscription-card-grid .grid-value {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .subscription-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .subscription-card-actions.single {
            grid-template-columns: 1fr;
        }

        /* Section Headers */
        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Labels */
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 16px;
        }

        /* Status Messages */
        .status-message {
            font-size: 14px;
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        /* Expandable sections */
        .expandable-section {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expandable-section.collapsed {
            max-height: 0;
        }

        .expandable-section.expanded {
            max-height: 2000px;
        }

        /* Legacy class support */
        .client-widget-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .floating-button {
            position: fixed;
            bottom: 160px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            max-width: calc(100% - 40px);
            width: 100%;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 100px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Balance display */
        .balance-display {
            background: var(--gradient-primary);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
            letter-spacing: -0.02em;
        }

        /* Ticket cards */
        .ticket-card {
            background: var(--surface-muted);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ticket-card:hover {
            background: var(--surface-strong);
            border-color: rgba(var(--primary-rgb), 0.2);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ticket-id {
            font-weight: 600;
            color: var(--text-primary);
        }

        .ticket-subject {
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .ticket-date {
            font-size: 12px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- SVG Icons Definitions -->
    <svg style="display: none;">
        <defs>
            <symbol id="icon-chart" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></symbol>
            <symbol id="icon-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
            <symbol id="icon-calendar" viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></symbol>
            <symbol id="icon-activity" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></symbol>
            <symbol id="icon-wallet" viewBox="0 0 24 24"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></symbol>
            <symbol id="icon-rocket" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></symbol>
            <symbol id="icon-credit-card" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></symbol>
            <symbol id="icon-mail" viewBox="0 0 24 24"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></symbol>
            <symbol id="icon-key" viewBox="0 0 24 24"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></symbol>
            <symbol id="icon-gift" viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect width="20" height="5" x="2" y="7"/><line x1="12" x2="12" y1="22" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></symbol>
            <symbol id="icon-users" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></symbol>
            <symbol id="icon-link" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></symbol>
            <symbol id="icon-bot" viewBox="0 0 24 24"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></symbol>
            <symbol id="icon-copy" viewBox="0 0 24 24"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></symbol>
            <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></symbol>
            <symbol id="icon-settings" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></symbol>
            <symbol id="icon-globe" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></symbol>
            <symbol id="icon-currency" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></symbol>
            <symbol id="icon-server" viewBox="0 0 24 24"><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></symbol>
            <symbol id="icon-diamond" viewBox="0 0 24 24"><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z"/></symbol>
            <symbol id="icon-message" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></symbol>
            <symbol id="icon-home" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></symbol>
            <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></symbol>
            <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></symbol>
            <symbol id="icon-x" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></symbol>
            <symbol id="icon-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5v14"/></symbol>
            <symbol id="icon-chevron-down" viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></symbol>
            <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></symbol>
            <symbol id="icon-crown" viewBox="0 0 24 24"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></symbol>
            <symbol id="icon-zap" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
            <symbol id="icon-shield" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></symbol>
            <symbol id="icon-infinity" viewBox="0 0 24 24"><path d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 0 0 0-8c-2 0-4 1.33-6 4Z"/></symbol>
        </defs>
    </svg>

    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div id="loadingText" style="color: var(--text-secondary); font-weight: 500;">Загрузка...</div>
        </div>

        <div id="content" class="hidden" style="position: relative;">
            <!-- Theme Toggle -->
            <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg class="icon icon-lg"><use href="#icon-sun"/></svg>
            </button>
            
            <!-- Branding -->
            <div id="brandingHeader" class="branding-header hidden">
                <img id="brandingLogo" class="branding-logo hidden" src="" alt="">
                <div class="branding-text">
                    <div id="brandingTitle" class="branding-title"></div>
                    <div id="brandingSubtitle" class="branding-subtitle"></div>
                </div>
            </div>

            <!-- Page 1: Dashboard — структура как у STELS -->
            <div id="pageInfo" class="page active" style="padding-bottom: 100px;">
                <!-- Заголовок приветствия -->
                <div class="dashboard-header">
                    <h1 id="dashboardWelcomeTitle">Добро пожаловать</h1>
                    <p id="dashboardWelcomeSubtitle">Ваша подписка</p>
                </div>

                <!-- Карточка подписки (bento): заголовок + сетка 2x2 + прогресс + кнопки -->
                <div class="card card-hero">
                    <div class="card-header" style="margin-bottom: 20px;">
                        <div>
                            <div class="card-title" style="margin-bottom: 4px;">
                                <svg class="icon"><use href="#icon-chart"/></svg>
                                <span id="subscriptionStatusTitle">Статус подписки</span>
                            </div>
                            <div id="tariffName" class="text-muted" style="font-size: 13px; display: none;"></div>
                        </div>
                        <span id="subscriptionStatus" class="status-badge status-inactive">
                            <span class="status-dot offline"></span>
                            Неактивна
                        </span>
                    </div>
                    <div class="subscription-card-grid">
                        <div>
                            <div class="grid-label" id="expiresLabel">Истекает</div>
                            <div id="expireDate" class="grid-value">-</div>
                        </div>
                        <div>
                            <div class="grid-label"><span id="trafficLabel">Трафик</span></div>
                            <div id="traffic" class="grid-value">-</div>
                        </div>
                        <div>
                            <div class="grid-label" id="devicesLabel">Устройств</div>
                            <div id="devicesValue" class="grid-value">-</div>
                        </div>
                        <div>
                            <div class="grid-label" id="daysLeftLabel">Осталось</div>
                            <div id="daysLeft" class="grid-value">-</div>
                        </div>
                    </div>
                    <div id="trafficProgress" class="progress-bar hidden" style="margin-bottom: 20px;">
                        <div id="trafficProgressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="connectButtonContainer" class="subscription-card-actions" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="switchPage('tariffs')">
                            <span id="viewSubscriptionText">Тарифы</span>
                        </button>
                        <button id="connectButton" class="btn" onclick="handleConnectClick(event)">
                            <svg class="icon"><use href="#icon-rocket"/></svg>
                            <span id="connectButtonText">Подключиться</span>
                        </button>
                    </div>
                    <div id="subscriptionCardActionsNoConnect" class="subscription-card-actions single" style="display: none;">
                        <button type="button" class="btn" onclick="switchPage('tariffs')">
                            <span id="viewSubscriptionText2">Перейти к тарифам</span>
                        </button>
                    </div>
                </div>

                <!-- Bento-сетка: Баланс, Подписка, Рефералы, Заработок -->
                <div class="stats-grid">
                    <a href="javascript:void(0)" class="bento-tile" onclick="var el = document.getElementById('balanceTopupForm'); if(el) el.scrollIntoView({behavior:'smooth', block:'center'});">
                        <div class="tile-label">
                            <span id="balanceTileLabel">Баланс</span>
                            <svg class="icon arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
                        </div>
                        <div id="userBalance" class="stat-value accent">-</div>
                    </a>
                    <a href="javascript:void(0)" class="bento-tile" onclick="switchPage('tariffs')">
                        <div class="tile-label">
                            <span id="subscriptionTileLabel">Подписка</span>
                            <svg class="icon arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
                        </div>
                        <div id="subscriptionDaysBento" class="stat-value">-</div>
                    </a>
                    <a href="javascript:void(0)" class="bento-tile" onclick="switchPage('profile')">
                        <div class="tile-label">
                            <span id="referralsTileLabel">Рефералы</span>
                            <svg class="icon arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
                        </div>
                        <div id="referralCount" class="stat-value">0</div>
                    </a>
                    <a href="javascript:void(0)" class="bento-tile" onclick="switchPage('profile')">
                        <div class="tile-label">
                            <span id="earningsTileLabel">Заработок</span>
                            <svg class="icon arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg>
                        </div>
                        <div id="referralEarnings" class="stat-value success">0</div>
                    </a>
                </div>

                <!-- Конфиги -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon"><use href="#icon-server"/></svg>
                            <span id="configsTitle">Мои конфиги</span>
                        </div>
                    </div>
                    <div id="configsList" class="configs-list">
                        <div class="text-center text-muted" id="configsLoadingText" style="padding: 24px;">
                            Загрузка конфигов...
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--glass-border);">
                        <button class="btn btn-sm" onclick="handleAddConfig()" id="addConfigBtn" style="width: 100%; padding: 10px 16px;">
                            <svg class="icon icon-sm"><use href="#icon-plus"/></svg>
                            <span id="addConfigBtnText">Добавить конфиг</span>
                        </button>
                    </div>
                </div>

                <!-- Balance Topup Card -->
                <div class="card">
                    <div class="widget-title">
                        <svg class="icon"><use href="#icon-credit-card"/></svg>
                        Пополнение баланса
                    </div>
                    <div class="balance-display">
                        <div class="balance-label">Текущий баланс</div>
                        <div id="balanceDisplay" class="balance-amount">0.00</div>
                    </div>
                    <form id="balanceTopupForm" onsubmit="handleBalanceTopup(event)">
                        <div class="form-group">
                            <label class="form-label">Сумма пополнения</label>
                            <input
                                type="number"
                                step="1"
                                min="1"
                                id="balanceAmount"
                                class="input"
                                placeholder="Введите сумму"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Способ оплаты</label>
                            <select id="topupPaymentMethod" class="select">
                                <option value="">Загрузка...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn" id="balanceTopupBtn">
                            <svg class="icon"><use href="#icon-credit-card"/></svg>
                            Пополнить баланс
                        </button>
                        <div id="balanceTopupStatus" class="status-message" style="display: none;"></div>
                    </form>
                </div>

            </div>

            <!-- Page 2: Servers -->
            <div id="pageServers" class="page">
                <!-- Subscription Progress -->
                <div id="serversSubscriptionCard" class="subscription-progress-card">
                    <div class="subscription-progress-header">
                        <div class="subscription-progress-title">
                            <svg class="icon icon-sm"><use href="#icon-clock"/></svg>
                            <span id="subscriptionProgressLabel">До окончания подписки</span>
                        </div>
                        <div class="subscription-days" id="subscriptionDaysLeft">-</div>
                    </div>
                    <div class="subscription-progress-bar">
                        <div id="subscriptionProgressFill" class="subscription-progress-fill" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Servers List -->
                <div class="card card-hero">
                    <div class="widget-title" id="serversTitle">
                        <svg class="icon"><use href="#icon-server"/></svg>
                        Серверы
                    </div>
                    <div id="serversList" class="server-list">
                        <div class="text-center text-muted" id="serversLoadingText" style="padding: 24px;">
                            Загрузка серверов...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 3: Tariffs -->
            <div id="pageTariffs" class="page" style="padding-bottom: 80px;">
                <!-- Promo Code for Tariffs -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon"><use href="#icon-gift"/></svg>
                            <span id="promoCodeTitle">Промокод</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="tariffPromoCodeInput" 
                            class="input"
                            placeholder="Введите промокод"
                            onkeypress="if(event.key === 'Enter') checkTariffPromoCode()"
                        />
                        <button class="btn" onclick="checkTariffPromoCode()" id="tariffPromoCheckBtn">
                            Применить
                        </button>
                    </div>
                    <div id="tariffPromoStatus" class="status-message" style="display: none;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon"><use href="#icon-diamond"/></svg>
                            Тарифы
                        </div>
                    </div>
                    <div id="tariffsList" class="tariff-grid">
                        <div class="text-center text-muted" id="tariffsLoadingText" style="padding: 24px;">
                            Загрузка тарифов...
                        </div>
                    </div>
                </div>

                <!-- Опции (внутри раздела Тарифы) -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon"><use href="#icon-plus"/></svg>
                            <span id="optionsTitle">Опции</span>
                        </div>
                    </div>
                    <div id="optionsList" class="tariff-grid">
                        <div class="text-center text-muted" id="optionsLoadingText" style="padding: 24px;">
                            Загрузка опций...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 4: Profile -->
            <div id="pageProfile" class="page">
                <!-- Support (opens modal) -->
                <div class="card">
                    <div class="widget-title">
                        <svg class="icon"><use href="#icon-message"/></svg>
                        <span id="profileSupportTitle">Поддержка</span>
                    </div>
                    <button class="btn" onclick="openSupportModal()">
                        <svg class="icon"><use href="#icon-message"/></svg>
                        <span id="openSupportBtnText">Открыть поддержку</span>
                    </button>
                </div>

                <!-- Login Data Card -->
                <div class="card">
                    <div class="widget-title" id="loginDataTitle">
                        <svg class="icon"><use href="#icon-key"/></svg>
                        Данные для входа
                    </div>
                    <div class="info-grid login-info-grid">
                        <div class="info-item">
                            <span class="info-label">
                                <svg class="icon icon-sm"><use href="#icon-mail"/></svg>
                                <span id="emailLabel">Email</span>
                            </span>
                            <span id="userEmail" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">
                                <svg class="icon icon-sm"><use href="#icon-key"/></svg>
                                <span id="passwordLabel">Пароль</span>
                            </span>
                            <span id="userPassword" class="info-value">-</span>
                        </div>
                    </div>
                </div>

                <!-- Promo Code Card -->
                <div class="card">
                    <div class="widget-title" id="promoActivationTitle">
                        <svg class="icon"><use href="#icon-gift"/></svg>
                        Активация промокода
                    </div>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="promoCodeInput" 
                            class="input"
                            placeholder="Введите код..."
                            id="promoCodeInputPlaceholder"
                        />
                        <button class="btn" onclick="activatePromoCode()" id="promoActivateBtn">
                            <span id="promoOkBtn">OK</span>
                        </button>
                    </div>
                    <div id="promoStatus" class="status-message" style="display: none;"></div>
                </div>

                <!-- Referral Program Card -->
                <div class="card">
                    <div class="widget-title" id="referralProgramTitle">
                        <svg class="icon"><use href="#icon-users"/></svg>
                        Реферальная программа
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <svg class="icon icon-sm" style="display: inline; vertical-align: -3px; margin-right: 6px;"><use href="#icon-link"/></svg>
                            <span id="referralLinkSiteLabel">Ссылка на сайт</span>
                        </label>
                        <div class="input-group">
                            <input type="text" id="referralLinkInput" class="input" readonly />
                            <button class="btn btn-icon" onclick="copyReferralLink()" id="referralCopyBtn">
                                <svg class="icon"><use href="#icon-copy"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <svg class="icon icon-sm" style="display: inline; vertical-align: -3px; margin-right: 6px;"><use href="#icon-bot"/></svg>
                            <span id="referralLinkBotLabel">Ссылка на бота</span>
                        </label>
                        <div class="input-group">
                            <input type="text" id="referralBotLinkInput" class="input" readonly />
                            <button class="btn btn-icon" onclick="copyReferralBotLink()" id="referralBotCopyBtn">
                                <svg class="icon"><use href="#icon-copy"/></svg>
                            </button>
                        </div>
                    </div>
                    <p id="shareLinkText" class="text-muted" style="font-size: 13px; margin-top: 12px;">
                        Поделитесь ссылкой с друзьями и получите бонусы!
                    </p>
                </div>

                <!-- Settings Card -->
                <div class="card">
                    <div class="widget-title" id="settingsTitle">
                        <svg class="icon"><use href="#icon-settings"/></svg>
                        Настройки
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <svg class="icon icon-sm" style="display: inline; vertical-align: -3px; margin-right: 6px;"><use href="#icon-currency"/></svg>
                            Валюта
                        </label>
                        <select id="currencySelect" class="select" onchange="changeCurrency()">
                            <!-- Options added dynamically -->
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">
                            <svg class="icon icon-sm" style="display: inline; vertical-align: -3px; margin-right: 6px;"><use href="#icon-globe"/></svg>
                            Язык
                        </label>
                        <select id="languageSelect" class="select" onchange="changeLanguage()">
                            <!-- Options added dynamically -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Page 6: Casino (показывается только если CASINO_ENABLED=true) -->
            <div id="pageCasino" class="page" style="padding-bottom: 80px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon"><use href="#icon-diamond"/></svg>
                            Фортуна
                        </div>
                    </div>
                    <p class="text-muted" style="padding: 0 16px 8px; font-size: 14px;">Ставка — дни подписки. Крутите колесо и выигрывайте до x5!</p>
                    <!-- Колесо фортуны: 7 секторов. Указатель сверху — под ним выпавший множитель -->
                    <div class="casino-wheel-wrap">
                        <div class="casino-wheel-pointer" title="Выигрыш здесь"></div>
                        <div id="casinoWheel" class="casino-wheel" style="transform: rotate(0deg);">
                            <!-- Порядок как на колесе: 0=x5, 1=x0, 2=x0.5, 3=x1, 4=x1.5, 5=x2, 6=x3 -->
                            <div class="casino-wheel-labels" aria-hidden="true">
                                <span class="casino-sector" data-idx="0">x5</span>
                                <span class="casino-sector" data-idx="1">x0</span>
                                <span class="casino-sector" data-idx="2">x0.5</span>
                                <span class="casino-sector" data-idx="3">x1</span>
                                <span class="casino-sector" data-idx="4">x1.5</span>
                                <span class="casino-sector" data-idx="5">x2</span>
                                <span class="casino-sector" data-idx="6">x3</span>
                            </div>
                        </div>
                        <div class="casino-wheel-center" id="casinoWheelCenter">?</div>
                    </div>
                    <p class="text-muted" style="font-size: 12px; margin: -8px 0 0; padding: 0 16px;">Указатель сверху — под ним выпавший множитель</p>
                    <div style="padding: 0 16px 16px;">
                        <div class="info-item" style="margin-bottom: 16px;">
                            <span class="info-label">Баланс (дней)</span>
                            <span id="casinoBalanceDays" class="info-value">0</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ставка (дней)</label>
                            <input type="number" id="casinoBetInput" class="input" min="1" max="30" value="1" />
                        </div>
                        <button type="button" class="btn btn-primary" id="casinoSpinBtn" onclick="casinoSpin()" style="width: 100%; margin-top: 12px;">Крутить</button>
                        <div id="casinoResult" class="status-message" style="display: none; margin-top: 16px;"></div>
                        <div id="casinoGamesLeft" class="text-muted" style="font-size: 13px; margin-top: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="hidden">
            <div class="card text-center">
                <svg class="icon icon-xl text-muted" style="margin: 0 auto 16px;"><use href="#icon-x"/></svg>
                <div id="errorLoadingText" class="text-muted">Ошибка загрузки</div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="bottom-nav-items">
            <div class="nav-item active" onclick="switchPage('info')" id="navInfo">
                <div class="nav-item-icon">
                    <svg class="icon"><use href="#icon-home"/></svg>
                </div>
                <div class="nav-item-label">Подписка</div>
            </div>
            <div class="nav-item" onclick="switchPage('servers')" id="navServers">
                <div class="nav-item-icon">
                    <svg class="icon"><use href="#icon-server"/></svg>
                </div>
                <div class="nav-item-label">Серверы</div>
            </div>
            <div class="nav-item" onclick="switchPage('tariffs')" id="navTariffs">
                <div class="nav-item-icon">
                    <svg class="icon"><use href="#icon-diamond"/></svg>
                </div>
                <div class="nav-item-label">Тарифы</div>
            </div>
            <div class="nav-item" onclick="switchPage('profile')" id="navProfile">
                <div class="nav-item-icon">
                    <svg class="icon"><use href="#icon-users"/></svg>
                </div>
                <div class="nav-item-label">Профиль</div>
            </div>
            <div class="nav-item" onclick="switchPage('casino')" id="navCasino" style="display: none;">
                <div class="nav-item-icon">
                    <svg class="icon"><use href="#icon-star"/></svg>
                </div>
                <div class="nav-item-label">Фортуна</div>
            </div>
        </div>
    </div>

    <!-- Tariffs Modal -->
    <div id="tariffsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="selectTariffTitle">Выберите тариф</div>
                <button class="close-btn" onclick="closeTariffsModal()">
                    <svg class="icon"><use href="#icon-x"/></svg>
                </button>
            </div>
            <div id="tariffsModalList" class="tariff-grid"></div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="selectPaymentTitle">Способ оплаты</div>
                <button class="close-btn" onclick="closePaymentModal()">
                    <svg class="icon"><use href="#icon-x"/></svg>
                </button>
            </div>
            <div id="paymentMethodsList" class="payment-methods"></div>
        </div>
    </div>

    <!-- Rename Config Modal -->
    <div id="renameConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="renameConfigTitle"></div>
                <button class="close-btn" onclick="closeRenameConfigModal()">
                    <svg class="icon"><use href="#icon-x"/></svg>
                </button>
            </div>
            <div class="form-group">
                <label class="form-label" id="renameConfigLabel"></label>
                <input
                    type="text"
                    id="renameConfigInput"
                    class="input"
                    value=""
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                />
            </div>
            <div style="display: flex; gap: 10px; margin-top: 12px;">
                <button class="btn" id="renameConfigSaveBtn" style="margin-top: 0; flex: 1;"></button>
                <button class="btn btn-secondary" id="renameConfigCancelBtn" style="margin-top: 0; flex: 1;"></button>
            </div>
        </div>
    </div>

    <!-- Tariff Details Modal -->
    <div id="tariffDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="tariffDetailsTitle">Детали тарифа</div>
                <button class="close-btn" onclick="closeTariffDetailsModal()">
                    <svg class="icon"><use href="#icon-x"/></svg>
                </button>
            </div>
            <div id="tariffDetailsContent" style="padding: 20px 0;">
                <!-- Контент будет заполнен динамически -->
            </div>
        </div>
    </div>

    <!-- Support Modal (opened from Profile) -->
    <div id="supportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="supportModalTitle">Поддержка</div>
                <button class="close-btn" onclick="closeSupportModal()">
                    <svg class="icon"><use href="#icon-x"/></svg>
                </button>
            </div>
            <div id="supportContent">
                <!-- Tickets List -->
                <div id="ticketsList" style="margin-bottom: 20px;">
                    <div class="text-center text-muted" id="ticketsLoadingText" style="padding: 16px;">
                        Загрузка тикетов...
                    </div>
                </div>
                
                <!-- Create Ticket Form -->
                <div id="createTicketForm" style="background: var(--surface-muted); border-radius: var(--radius); padding: 20px; margin-top: 16px;">
                    <div class="widget-title" style="margin-bottom: 16px;">
                        <svg class="icon"><use href="#icon-plus"/></svg>
                        <span id="createTicketText">Создать тикет</span>
                    </div>
                    <div class="form-group">
                        <input 
                            type="text" 
                            id="ticketSubject" 
                            class="input"
                            placeholder="Тема тикета"
                        />
                    </div>
                    <div class="form-group">
                        <textarea 
                            id="ticketMessage" 
                            class="input"
                            placeholder="Сообщение" 
                            rows="4"
                            style="resize: vertical; min-height: 100px;"
                        ></textarea>
                    </div>
                    <button class="btn" onclick="createTicket()">
                        <svg class="icon"><use href="#icon-message"/></svg>
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let userData = null;
        let tariffs = [];
        let tariffLevels = [];
        let tariffFeaturesByTier = {}; // { tier_code: [features...] }
        let openTariffTier = null; // текущий открытый tier в аккордеоне
        let servers = [];
        let selectedTariffId = null;
        let selectedOptionId = null;
        let selectedConfigId = null; // ID конфига для оплаты
        let createNewConfig = false; // Флаг создания нового конфига после оплаты
        let paymentMethods = [];
        let branding = {};
        let botConfig = {};
        let serversExpanded = false;
        let currentPage = 'info';
        let casinoEnabled = false;
        let casinoConfig = {};
        let casinoWheelRotation = 0; // текущий угол колеса (градусы)
        let appliedPromo = null; // Примененный промокод для тарифов
        let tickets = []; // Список тикетов
        let purchaseOptions = { traffic: [], devices: [], squad: [] };
        let purchaseOptionsLoaded = false;
        let serverDomain = ''; // Домен сервера для рефералки (подставляется из API)
        let botUsername = ''; // Username бота для реферальной ссылки
        // Загружаем валюту из localStorage или используем дефолтную
        let currentCurrency = localStorage.getItem('preferredCurrency') || 'uah';
        let currentLanguage = localStorage.getItem('preferredLanguage') || 'ru';
        // Активные языки и валюты из настроек
        let activeLanguages = ['ru', 'ua', 'en', 'cn'];
        let activeCurrencies = ['uah', 'rub', 'usd'];

        // Финальная цена тарифа с учётом промокода
        function getFinalTariffPrice(basePrice) {
            if (!appliedPromo || basePrice == null) return basePrice;
            if (appliedPromo.type === 'PERCENT') {
                return Math.max(0, basePrice * (1 - appliedPromo.value / 100));
            }
            if (appliedPromo.type === 'FIXED') {
                return Math.max(0, basePrice - appliedPromo.value);
            }
            return basePrice;
        }

        // Переводы
        const translations = {
            ru: {
                loading: 'Загрузка...',
                welcome: 'Добро пожаловать',
                welcomeName: 'Добро пожаловать, {name}',
                yourSubscription: 'Ваша подписка',
                subscriptionStatus: 'Статус подписки',
                balanceTileLabel: 'Баланс',
                subscriptionTileLabel: 'Подписка',
                referralsTileLabel: 'Рефералы',
                earningsTileLabel: 'Заработок',
                viewSubscriptionText: 'Тарифы',
                viewSubscriptionText2: 'Перейти к тарифам',
                active: 'Активна',
                inactive: 'Неактивна',
                expires: 'Истекает:',
                daysLeft: 'Осталось дней:',
                traffic: 'Трафик:',
                devicesLabel: 'Устройств',
                devices_available: 'доступно',
                devices_unlimited: 'Безлимит',
                unlimited: 'Безлимитный',
                expired: 'Истекла',
                days: 'дн.',
                loginData: 'Данные для входа',
                email: 'Email:',
                password: 'Пароль:',
                notAvailable: 'Не доступен',
                promoActivation: 'Активация промокода',
                enterCode: 'Введите код...',
                promoCode: 'Промокод',
                apply: 'Применить',
                referralProgram: 'Реферальная программа',
                shareLink: 'Поделитесь ссылкой с друзьями и получите бонусы!',
                referralCodeNotFound: 'Реферальный код не найден',
                referralLinkSite: 'Ссылка на сайт',
                referralLinkBot: 'Ссылка на бота',
                linkCopied: 'Ссылка скопирована!',
                settings: 'Настройки',
                currency: 'Валюта',
                language: 'Язык',
                servers: 'Серверы',
                serversLoading: 'Загрузка серверов...',
                ticketsLoading: 'Загрузка тикетов...',
                serversNotFound: 'Серверы не найдены',
                activateSubscription: 'Активируйте подписку для просмотра серверов',
                tariffs: 'Тарифы',
                options: 'Опции',
                tariffsLoading: 'Загрузка тарифов...',
                tariffsNotFound: 'Тарифы не найдены',
                selectTariff: 'Выберите тариф',
                selectPayment: 'Выберите способ оплаты',
                support: 'Поддержка',
                openSupport: 'Открыть поддержку',
                info: 'Подписка',
                profile: 'Профиль',
                myTickets: 'Мои тикеты',
                noTickets: 'У вас пока нет тикетов',
                createTicket: 'Создать тикет',
                ticketSubject: 'Тема тикета',
                message: 'Сообщение',
                send: 'Отправить',
                connect: 'Подключиться',
                registrationRequired: 'Требуется регистрация',
                registrationMessage: 'Для использования мини-приложения необходимо зарегистрироваться в боте. Пожалуйста, откройте бота и пройдите регистрацию.',
                openBot: 'Открыть бота',
                error: 'Ошибка',
                errorLoading: 'Ошибка загрузки данных',
                errorLoadingServers: 'Ошибка загрузки серверов',
                errorLoadingTickets: 'Ошибка загрузки тикетов',
                fillAllFields: 'Заполните все поля',
                ticketCreated: 'Тикет создан успешно!',
                errorCreatingTicket: 'Ошибка создания тикета',
                currencyChanged: 'Валюта изменена',
                languageChanged: 'Язык изменен',
                promoActivated: 'Промокод активирован',
                promoError: 'Ошибка активации промокода',
                promoApplied: 'Промокод применен',
                promoInvalid: 'Неверный промокод',
                basic: 'Базовый',
                premium: 'Премиум',
                elite: 'Элитный',
                daysWord: 'дней',
                ticket: 'Тикет',
                ticketNum: 'Тикет #',
                open: 'Открыт',
                closed: 'Закрыт',
                ok: 'OK',
                errorAuth: 'Ошибка авторизации',
                errorPayment: 'Ошибка создания платежа',
                errorCopy: 'Ошибка копирования',
                errorPromoCheck: 'Ошибка проверки промокода',
                promoAppliedWithDiscount: 'Промокод применен! Скидка',
                promoDaysActivate: 'Промокод на бесплатные дни активируется на странице подписки',
                enterPromoCode: 'Введите промокод',
                viewTicketOnSite: 'Для просмотра перейдите на сайт',
                errorGettingToken: 'Ошибка получения токена',
                noAuthData: 'Нет данных авторизации',
                errorLoadingSubscription: 'Ошибка загрузки данных подписки',
                myConfigs: 'Мои конфиги',
                addConfig: 'Добавить конфиг',
                renewConfig: 'Продлить',
                connectConfig: 'Подключиться',
                copyConfigLink: 'Копировать',
                linkCopied: 'Ссылка скопирована!',
                configCreating: 'Создание конфига...',
                configCreated: 'Конфиг создан успешно!',
                configError: 'Ошибка создания конфига',
                configsLoading: 'Загрузка конфигов...',
                configsNotFound: 'Конфиги не найдены',
                configActive: 'Активен',
                configInactive: 'Неактивен',
                expiresAt: 'Истекает:',
                noExpireDate: 'Нет подписки',
                noSubscriptionUrl: 'Ссылка недоступна',
                renameConfig: 'Переименовать',
                deleteConfig: 'Удалить',
                cancel: 'Отмена',
                enterConfigName: 'Введите имя конфига',
                confirmDeleteConfig: 'Удалить этот конфиг?',
                configRenamed: 'Имя конфига обновлено',
                configDeleted: 'Конфиг удалён',
                cannotRenamePrimaryConfig: 'Основной конфиг переименовать нельзя',
                cannotDeletePrimaryConfig: 'Основной конфиг удалить нельзя',
                tariffFeaturesTitle: 'Функции тарифа'
            },
            ua: {
                loading: 'Завантаження...',
                welcome: 'Ласкаво просимо',
                welcomeName: 'Ласкаво просимо, {name}',
                yourSubscription: 'Ваша підписка',
                subscriptionStatus: 'Статус підписки',
                balanceTileLabel: 'Баланс',
                subscriptionTileLabel: 'Підписка',
                referralsTileLabel: 'Реферали',
                earningsTileLabel: 'Заробіток',
                viewSubscriptionText: 'Тарифи',
                viewSubscriptionText2: 'Перейти до тарифів',
                active: 'Активна',
                inactive: 'Неактивна',
                expires: 'Закінчується:',
                daysLeft: 'Залишилось днів:',
                traffic: 'Трафік:',
                devicesLabel: 'Устройств',
                devices_available: 'доступно',
                devices_unlimited: 'Безлимит',
                unlimited: 'Безлімітний',
                expired: 'Закінчилась',
                days: 'дн.',
                loginData: 'Дані для входу',
                email: 'Email:',
                password: 'Пароль:',
                notAvailable: 'Не доступний',
                promoActivation: 'Активація промокоду',
                enterCode: 'Введіть код...',
                promoCode: 'Промокод',
                apply: 'Застосувати',
                referralProgram: 'Реферальна програма',
                shareLink: 'Поділіться посиланням з друзями та отримайте бонуси!',
                referralCodeNotFound: 'Реферальний код не знайдено',
                referralLinkSite: 'Посилання на сайт',
                referralLinkBot: 'Посилання на бота',
                linkCopied: 'Посилання скопійовано!',
                settings: 'Налаштування',
                currency: 'Валюта',
                language: 'Мова',
                servers: 'Доступні сервери',
                serversLoading: 'Завантаження серверів...',
                ticketsLoading: 'Завантаження тікетів...',
                serversNotFound: 'Сервери не знайдено',
                activateSubscription: 'Активуйте підписку для перегляду серверів',
                tariffs: 'Тарифи',
                options: 'Опції',
                tariffsLoading: 'Завантаження тарифів...',
                tariffsNotFound: 'Тарифи не знайдено',
                selectTariff: 'Виберіть тариф',
                selectPayment: 'Виберіть спосіб оплати',
                support: 'Підтримка',
                openSupport: 'Відкрити підтримку',
                info: 'Підписка',
                profile: 'Профіль',
                myTickets: 'Мої тікети',
                noTickets: 'У вас поки немає тікетів',
                createTicket: 'Створити тікет',
                ticketSubject: 'Тема тікету',
                message: 'Повідомлення',
                send: 'Відправити',
                connect: 'Підключитися',
                registrationRequired: 'Потрібна реєстрація',
                registrationMessage: 'Для використання міні-додатку необхідно зареєструватися в боті. Будь ласка, відкрийте бота та пройдіть реєстрацію.',
                openBot: 'Відкрити бота',
                error: 'Помилка',
                errorLoading: 'Помилка завантаження даних',
                errorLoadingServers: 'Помилка завантаження серверів',
                errorLoadingTickets: 'Помилка завантаження тікетів',
                fillAllFields: 'Заповніть всі поля',
                ticketCreated: 'Тікет створено успішно!',
                errorCreatingTicket: 'Помилка створення тікету',
                currencyChanged: 'Валюту змінено',
                languageChanged: 'Мову змінено',
                promoActivated: 'Промокод активовано',
                promoError: 'Помилка активації промокоду',
                promoApplied: 'Промокод застосовано',
                promoInvalid: 'Невірний промокод',
                basic: 'Базовий',
                premium: 'Преміум',
                elite: 'Елітний',
                daysWord: 'днів',
                ticket: 'Тікет',
                ticketNum: 'Тікет #',
                open: 'Відкрито',
                closed: 'Закрито',
                ok: 'OK',
                errorAuth: 'Помилка авторизації',
                errorPayment: 'Помилка створення платежу',
                errorCopy: 'Помилка копіювання',
                errorPromoCheck: 'Помилка перевірки промокоду',
                promoAppliedWithDiscount: 'Промокод застосовано! Знижка',
                promoDaysActivate: 'Промокод на безкоштовні дні активується на сторінці підписки',
                enterPromoCode: 'Введіть промокод',
                viewTicketOnSite: 'Для перегляду перейдіть на сайт',
                errorGettingToken: 'Помилка отримання токена',
                noAuthData: 'Немає даних авторизації',
                errorLoadingSubscription: 'Помилка завантаження даних підписки',
                myConfigs: 'Мої конфіги',
                addConfig: 'Додати конфіг',
                renewConfig: 'Продовжити',
                connectConfig: 'Підключитися',
                copyConfigLink: 'Копіювати',
                linkCopied: 'Посилання скопійовано!',
                configCreating: 'Створення конфігу...',
                configCreated: 'Конфіг створено успішно!',
                configError: 'Помилка створення конфігу',
                configsLoading: 'Завантаження конфігів...',
                configsNotFound: 'Конфіги не знайдено',
                configActive: 'Активний',
                configInactive: 'Неактивний',
                expiresAt: 'Закінчується:',
                noExpireDate: 'Немає підписки',
                noSubscriptionUrl: 'Посилання недоступне',
                renameConfig: 'Перейменувати',
                deleteConfig: 'Видалити',
                cancel: 'Скасувати',
                enterConfigName: "Введіть ім'я конфігу",
                confirmDeleteConfig: 'Видалити цей конфіг?',
                configRenamed: "Ім'я конфігу оновлено",
                configDeleted: 'Конфіг видалено',
                cannotRenamePrimaryConfig: 'Основний конфіг не можна перейменувати',
                cannotDeletePrimaryConfig: 'Основний конфіг не можна видалити',
                tariffFeaturesTitle: 'Функції тарифу'
            },
            en: {
                loading: 'Loading...',
                welcome: 'Welcome',
                welcomeName: 'Welcome, {name}',
                yourSubscription: 'Your subscription',
                subscriptionStatus: 'Subscription Status',
                balanceTileLabel: 'Balance',
                subscriptionTileLabel: 'Subscription',
                referralsTileLabel: 'Referrals',
                earningsTileLabel: 'Earnings',
                viewSubscriptionText: 'Tariffs',
                viewSubscriptionText2: 'View tariffs',
                active: 'Active',
                inactive: 'Inactive',
                expires: 'Expires:',
                daysLeft: 'Days Left:',
                traffic: 'Traffic:',
                devicesLabel: 'Devices',
                devices_available: 'available',
                devices_unlimited: 'Unlimited',
                unlimited: 'Unlimited',
                expired: 'Expired',
                days: 'days',
                loginData: 'Login Data',
                email: 'Email:',
                password: 'Password:',
                notAvailable: 'Not available',
                promoActivation: 'Promo Code Activation',
                enterCode: 'Enter code...',
                promoCode: 'Promo Code',
                apply: 'Apply',
                referralProgram: 'Referral Program',
                shareLink: 'Share the link with friends and get bonuses!',
                referralCodeNotFound: 'Referral code not found',
                referralLinkSite: 'Website link',
                referralLinkBot: 'Bot link',
                linkCopied: 'Link copied!',
                settings: 'Settings',
                currency: 'Currency',
                language: 'Language',
                servers: 'Available Servers',
                serversLoading: 'Loading servers...',
                ticketsLoading: 'Loading tickets...',
                serversNotFound: 'Servers not found',
                activateSubscription: 'Activate subscription to view servers',
                tariffs: 'Tariffs',
                options: 'Options',
                tariffsLoading: 'Loading tariffs...',
                tariffsNotFound: 'Tariffs not found',
                selectTariff: 'Select Tariff',
                selectPayment: 'Select Payment Method',
                support: 'Support',
                openSupport: 'Open Support',
                info: 'Subscription',
                profile: 'Profile',
                myTickets: 'My Tickets',
                noTickets: 'You have no tickets yet',
                createTicket: 'Create Ticket',
                ticketSubject: 'Ticket Subject',
                message: 'Message',
                send: 'Send',
                connect: 'Connect',
                registrationRequired: 'Registration Required',
                registrationMessage: 'To use the mini app, you need to register in the bot. Please open the bot and complete registration.',
                openBot: 'Open Bot',
                error: 'Error',
                errorLoading: 'Error loading data',
                errorLoadingServers: 'Error loading servers',
                errorLoadingTickets: 'Error loading tickets',
                fillAllFields: 'Fill all fields',
                ticketCreated: 'Ticket created successfully!',
                errorCreatingTicket: 'Error creating ticket',
                currencyChanged: 'Currency changed',
                languageChanged: 'Language changed',
                promoActivated: 'Promo code activated',
                promoError: 'Error activating promo code',
                promoApplied: 'Promo code applied',
                promoInvalid: 'Invalid promo code',
                basic: 'Basic',
                premium: 'Premium',
                elite: 'Elite',
                daysWord: 'days',
                ticket: 'Ticket',
                ticketNum: 'Ticket #',
                open: 'Open',
                closed: 'Closed',
                ok: 'OK',
                errorAuth: 'Authorization error',
                errorPayment: 'Error creating payment',
                errorCopy: 'Copy error',
                errorPromoCheck: 'Error checking promo code',
                promoAppliedWithDiscount: 'Promo code applied! Discount',
                promoDaysActivate: 'Free days promo code is activated on the subscription page',
                enterPromoCode: 'Enter promo code',
                viewTicketOnSite: 'Go to the website to view',
                errorGettingToken: 'Error getting token',
                noAuthData: 'No authorization data',
                errorLoadingSubscription: 'Error loading subscription data',
                myConfigs: 'My Configs',
                addConfig: 'Add Config',
                renewConfig: 'Renew',
                connectConfig: 'Connect',
                copyConfigLink: 'Copy',
                linkCopied: 'Link copied!',
                configCreating: 'Creating config...',
                configCreated: 'Config created successfully!',
                configError: 'Error creating config',
                configsLoading: 'Loading configs...',
                configsNotFound: 'Configs not found',
                configActive: 'Active',
                configInactive: 'Inactive',
                expiresAt: 'Expires:',
                noExpireDate: 'No subscription',
                noSubscriptionUrl: 'Link unavailable',
                renameConfig: 'Rename',
                deleteConfig: 'Delete',
                cancel: 'Cancel',
                enterConfigName: 'Enter config name',
                confirmDeleteConfig: 'Delete this config?',
                configRenamed: 'Config name updated',
                configDeleted: 'Config deleted',
                cannotRenamePrimaryConfig: 'Primary config cannot be renamed',
                cannotDeletePrimaryConfig: 'Primary config cannot be deleted',
                tariffFeaturesTitle: 'Tariff features'
            },
            cn: {
                loading: '加载中...',
                welcome: '欢迎',
                welcomeName: '欢迎，{name}',
                yourSubscription: '您的订阅',
                subscriptionStatus: '订阅状态',
                balanceTileLabel: '余额',
                subscriptionTileLabel: '订阅',
                referralsTileLabel: '推荐',
                earningsTileLabel: '收益',
                viewSubscriptionText: '套餐',
                viewSubscriptionText2: '查看套餐',
                active: '活跃',
                inactive: '非活跃',
                expires: '到期:',
                daysLeft: '剩余天数:',
                traffic: '流量:',
                devicesLabel: '设备',
                devices_available: '可用',
                devices_unlimited: '无限制',
                unlimited: '无限制',
                expired: '已过期',
                days: '天',
                loginData: '登录数据',
                email: '邮箱:',
                password: '密码:',
                notAvailable: '不可用',
                promoActivation: '促销代码激活',
                enterCode: '输入代码...',
                promoCode: '促销代码',
                apply: '应用',
                referralProgram: '推荐计划',
                shareLink: '与朋友分享链接并获得奖励！',
                referralCodeNotFound: '未找到推荐代码',
                referralLinkSite: '网站链接',
                referralLinkBot: '机器人链接',
                linkCopied: '链接已复制！',
                settings: '设置',
                currency: '货币',
                language: '语言',
                servers: '可用服务器',
                serversLoading: '加载服务器...',
                ticketsLoading: '加载工单...',
                serversNotFound: '未找到服务器',
                activateSubscription: '激活订阅以查看服务器',
                tariffs: '资费',
                options: '选项',
                tariffsLoading: '加载资费...',
                tariffsNotFound: '未找到资费',
                selectTariff: '选择资费',
                selectPayment: '选择付款方式',
                support: '支持',
                openSupport: '打开支持',
                info: '订阅',
                profile: '个人资料',
                myTickets: '我的工单',
                noTickets: '您还没有工单',
                createTicket: '创建工单',
                ticketSubject: '工单主题',
                message: '消息',
                send: '发送',
                connect: '连接',
                registrationRequired: '需要注册',
                registrationMessage: '要使用迷你应用程序，您需要在机器人中注册。请打开机器人并完成注册。',
                openBot: '打开机器人',
                error: '错误',
                errorLoading: '加载数据错误',
                errorLoadingServers: '加载服务器错误',
                errorLoadingTickets: '加载工单错误',
                fillAllFields: '填写所有字段',
                ticketCreated: '工单创建成功！',
                errorCreatingTicket: '创建工单错误',
                currencyChanged: '货币已更改',
                languageChanged: '语言已更改',
                promoActivated: '促销代码已激活',
                promoError: '激活促销代码错误',
                promoApplied: '促销代码已应用',
                promoInvalid: '无效的促销代码',
                basic: '基础',
                premium: '高级',
                elite: '精英',
                daysWord: '天',
                ticket: '工单',
                ticketNum: '工单 #',
                open: '打开',
                closed: '关闭',
                ok: '确定',
                errorAuth: '授权错误',
                errorPayment: '创建付款错误',
                errorCopy: '复制错误',
                errorPromoCheck: '检查促销代码错误',
                promoAppliedWithDiscount: '促销代码已应用！折扣',
                promoDaysActivate: '免费天数促销代码在订阅页面激活',
                enterPromoCode: '输入促销代码',
                viewTicketOnSite: '转到网站查看',
                errorGettingToken: '获取令牌错误',
                noAuthData: '无授权数据',
                errorLoadingSubscription: '加载订阅数据错误',
                myConfigs: '我的配置',
                addConfig: '添加配置',
                renewConfig: '续费',
                connectConfig: '连接',
                copyConfigLink: '复制',
                linkCopied: '链接已复制！',
                configCreating: '正在创建配置...',
                configCreated: '配置创建成功！',
                configError: '创建配置错误',
                configsLoading: '加载配置中...',
                configsNotFound: '未找到配置',
                configActive: '活跃',
                configInactive: '未活跃',
                expiresAt: '到期时间:',
                noExpireDate: '无订阅',
                noSubscriptionUrl: '链接不可用',
                renameConfig: '重命名',
                deleteConfig: '删除',
                cancel: '取消',
                enterConfigName: '输入配置名称',
                confirmDeleteConfig: '删除此配置？',
                configRenamed: '配置名称已更新',
                configDeleted: '配置已删除',
                cannotRenamePrimaryConfig: '主配置无法重命名',
                cannotDeletePrimaryConfig: '主配置无法删除',
                tariffFeaturesTitle: '套餐功能'
            }
        };

        function t(key) {
            return translations[currentLanguage]?.[key] || translations['ru'][key] || key;
        }

        function updateLanguageUI() {
            // Обновляем все тексты на странице
            const loadingText = document.getElementById('loadingText');
            if (loadingText) loadingText.textContent = t('loading');
            
            const errorLoadingText = document.getElementById('errorLoadingText');
            if (errorLoadingText) errorLoadingText.textContent = t('errorLoading');
            
            const serversLoadingText = document.getElementById('serversLoadingText');
            if (serversLoadingText) serversLoadingText.textContent = t('serversLoading');
            
            const tariffsLoadingText = document.getElementById('tariffsLoadingText');
            if (tariffsLoadingText) tariffsLoadingText.textContent = t('tariffsLoading');
            
            const ticketsLoadingText = document.getElementById('ticketsLoadingText');
            if (ticketsLoadingText) ticketsLoadingText.textContent = t('ticketsLoading');
            
            const selectTariffTitle = document.getElementById('selectTariffTitle');
            if (selectTariffTitle) selectTariffTitle.textContent = t('selectTariff');
            
            const selectPaymentTitle = document.getElementById('selectPaymentTitle');
            if (selectPaymentTitle) selectPaymentTitle.textContent = t('selectPayment');
            
            const createTicketText = document.getElementById('createTicketText');
            if (createTicketText) createTicketText.textContent = t('createTicket');

            const profileSupportTitle = document.getElementById('profileSupportTitle');
            if (profileSupportTitle) profileSupportTitle.textContent = t('support');

            const openSupportBtnText = document.getElementById('openSupportBtnText');
            if (openSupportBtnText) openSupportBtnText.textContent = t('openSupport');

            const supportModalTitle = document.getElementById('supportModalTitle');
            if (supportModalTitle) supportModalTitle.textContent = t('support');

            const ticketSubject = document.getElementById('ticketSubject');
            if (ticketSubject) ticketSubject.placeholder = t('ticketSubject');

            const ticketMessage = document.getElementById('ticketMessage');
            if (ticketMessage) ticketMessage.placeholder = t('message');
            
            const promoOkBtn = document.getElementById('promoOkBtn');
            if (promoOkBtn) promoOkBtn.textContent = t('ok');
            
            // Обновляем заголовки блоков
            const subscriptionStatusTitle = document.getElementById('subscriptionStatusTitle');
            if (subscriptionStatusTitle) subscriptionStatusTitle.textContent = t('subscriptionStatus');
            
            const loginDataTitle = document.getElementById('loginDataTitle');
            if (loginDataTitle) loginDataTitle.textContent = t('loginData');
            
            const promoActivationTitle = document.getElementById('promoActivationTitle');
            if (promoActivationTitle) promoActivationTitle.textContent = t('promoActivation');
            
            const configsTitle = document.getElementById('configsTitle');
            if (configsTitle) configsTitle.textContent = t('myConfigs');
            
            const addConfigBtnText = document.getElementById('addConfigBtnText');
            if (addConfigBtnText) addConfigBtnText.textContent = t('addConfig');
            
            const referralProgramTitle = document.getElementById('referralProgramTitle');
            if (referralProgramTitle) referralProgramTitle.textContent = t('referralProgram');
            
            const settingsTitle = document.getElementById('settingsTitle');
            if (settingsTitle) settingsTitle.textContent = t('settings');
            
            const serversTitle = document.getElementById('serversTitle');
            if (serversTitle) serversTitle.textContent = t('servers');
            
            const promoCodeTitle = document.getElementById('promoCodeTitle');
            if (promoCodeTitle) promoCodeTitle.textContent = t('promoCode');
            
            if (typeof updateDashboardWelcome === 'function') updateDashboardWelcome();
            const balanceTileLabel = document.getElementById('balanceTileLabel');
            if (balanceTileLabel) balanceTileLabel.textContent = t('balanceTileLabel');
            const subscriptionTileLabel = document.getElementById('subscriptionTileLabel');
            if (subscriptionTileLabel) subscriptionTileLabel.textContent = t('subscriptionTileLabel');
            const referralsTileLabel = document.getElementById('referralsTileLabel');
            if (referralsTileLabel) referralsTileLabel.textContent = t('referralsTileLabel');
            const earningsTileLabel = document.getElementById('earningsTileLabel');
            if (earningsTileLabel) earningsTileLabel.textContent = t('earningsTileLabel');
            const viewSubscriptionText = document.getElementById('viewSubscriptionText');
            if (viewSubscriptionText) viewSubscriptionText.textContent = t('viewSubscriptionText');
            const viewSubscriptionText2 = document.getElementById('viewSubscriptionText2');
            if (viewSubscriptionText2) viewSubscriptionText2.textContent = t('viewSubscriptionText2');
            
            // Обновляем метки полей
            const expiresLabel = document.getElementById('expiresLabel');
            if (expiresLabel) expiresLabel.textContent = t('expires');
            
            const daysLeftLabel = document.getElementById('daysLeftLabel');
            if (daysLeftLabel) daysLeftLabel.textContent = t('daysLeft');
            
            const devicesLabel = document.getElementById('devicesLabel');
            if (devicesLabel) devicesLabel.textContent = t('devicesLabel');
            const trafficLabel = document.getElementById('trafficLabel');
            if (trafficLabel) trafficLabel.textContent = t('traffic');
            
            const emailLabel = document.getElementById('emailLabel');
            if (emailLabel) emailLabel.textContent = t('email');
            
            const passwordLabel = document.getElementById('passwordLabel');
            if (passwordLabel) passwordLabel.textContent = t('password');
            
            // Обновляем плейсхолдеры
            const promoCodeInputPlaceholder = document.getElementById('promoCodeInputPlaceholder');
            if (promoCodeInputPlaceholder) promoCodeInputPlaceholder.placeholder = t('enterCode');
            
            // Обновляем текст реферальной программы
            const shareLinkText = document.getElementById('shareLinkText');
            if (shareLinkText) shareLinkText.textContent = t('shareLink');
            
            const referralLinkSiteLabel = document.getElementById('referralLinkSiteLabel');
            if (referralLinkSiteLabel) referralLinkSiteLabel.textContent = t('referralLinkSite');
            
            const referralLinkBotLabel = document.getElementById('referralLinkBotLabel');
            if (referralLinkBotLabel) referralLinkBotLabel.textContent = t('referralLinkBot');

            // Обновляем навигацию
            const navInfo = document.getElementById('navInfo')?.querySelector('.nav-item-label');
            if (navInfo) navInfo.textContent = t('info');
            
            const navServers = document.getElementById('navServers')?.querySelector('.nav-item-label');
            if (navServers) navServers.textContent = t('servers');
            
            const navTariffs = document.getElementById('navTariffs')?.querySelector('.nav-item-label');
            if (navTariffs) navTariffs.textContent = t('tariffs');

            const navOptions = document.getElementById('navOptions')?.querySelector('.nav-item-label');
            if (navOptions) navOptions.textContent = t('options');
            
            const navProfile = document.getElementById('navProfile')?.querySelector('.nav-item-label');
            if (navProfile) navProfile.textContent = t('profile');

            const optionsTitle = document.getElementById('optionsTitle');
            if (optionsTitle) optionsTitle.textContent = t('options');

            // Обновляем кнопку подключения
            const connectBtn = document.getElementById('floatingConnectBtn');
            if (connectBtn) {
                connectBtn.innerHTML = `<svg class="icon"><use href="#icon-rocket"/></svg> ${t('connect')}`;
            }
            
            // Перерисовываем тарифы и серверы, чтобы обновить тексты
            if (tariffs && tariffs.length > 0) {
                renderTariffs();
            }
            if (servers && servers.length > 0) {
                renderServers();
            }
        }

        // Определение темы (темная тема по умолчанию)
        let currentTheme = localStorage.getItem('preferredTheme') || 'dark';
        
        // Устанавливаем тему при загрузке
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('preferredTheme', theme);
            var metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) metaTheme.setAttribute('content', theme === 'dark' ? '#1a2234' : '#fafbfc');
            updateThemeToggle();
        }
        
        // Инициализация темы
        setTheme(currentTheme);
        
        // Функция переключения темы
        function toggleTheme() {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        // Обновление иконки переключателя темы
        function updateThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                // В темной теме показываем солнце (для переключения на светлую)
                // В светлой теме показываем луну (для переключения на темную)
                const iconId = currentTheme === 'dark' ? '#icon-sun' : '#icon-moon';
                themeToggle.innerHTML = `<svg class="icon icon-lg"><use href="${iconId}"/></svg>`;
                
                // Подсказка показывает, на какую тему можно переключиться
                const tooltip = currentTheme === 'dark' 
                    ? 'Переключить на светлую тему' 
                    : 'Переключить на темную тему';
                themeToggle.setAttribute('title', tooltip);
                themeToggle.setAttribute('aria-label', tooltip);
            }
        }

        // Загрузка брендинга
        async function loadBranding() {
            try {
                const response = await fetch('/api/public/branding');
                if (response.ok) {
                    branding = await response.json();
                    applyBranding();
                }
            } catch (error) {
                console.error('Ошибка загрузки брендинга:', error);
            }
        }

        // Загрузка конфигурации фортуны (вкладка показывается только если CASINO_ENABLED=true)
        async function loadCasinoConfig() {
            try {
                const response = await fetch('/miniapp/casino/config');
                if (response.ok) {
                    const data = await response.json();
                    casinoEnabled = !!data.enabled;
                    casinoConfig = data;
                    const navCasino = document.getElementById('navCasino');
                    if (navCasino) navCasino.style.display = casinoEnabled ? 'flex' : 'none';
                }
            } catch (error) {
                console.error('Ошибка загрузки конфигурации фортуны:', error);
            }
        }

        // Загрузка конфигурации бота
        async function loadBotConfig() {
            try {
                const response = await fetch('/api/public/bot-config');
                if (response.ok) {
                    botConfig = await response.json();
                    // Получаем username бота из конфигурации
                    botUsername = botConfig.bot_username || botConfig.username || '';
                    // Убираем @ если есть
                    if (botUsername && botUsername.startsWith('@')) {
                        botUsername = botUsername.substring(1);
                    }
                    // Если нет в конфигурации, пробуем получить из bot_link_for_miniapp
                    if (!botUsername && botConfig.bot_link_for_miniapp) {
                        const match = botConfig.bot_link_for_miniapp.match(/t\.me\/([^\/\?]+)/);
                        if (match) {
                            botUsername = match[1];
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки конфигурации бота:', error);
            }
        }

        // Загрузка платежных методов для пополнения баланса
        async function loadTopupPaymentMethods() {
            try {
                const response = await fetch('/miniapp/payments/methods', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                if (response.ok) {
                    const data = await response.json();
                    const methods = data.methods || [];
                    const select = document.getElementById('topupPaymentMethod');
                    if (select) {
                        const icons = {
                            'crystalpay': '💳',
                            'heleket': '₿',
                            'yookassa': '🏦',
                            'platega': '💳',
                            'platega_mir': '💳',
                            'telegram_stars': '⭐',
                            'monobank': '🏦',
                            'freekassa': '💰',
                            'robokassa': '🤖',
                            'kassa_ai': '💳'
                        };
                        select.innerHTML = methods.map(m => {
                            const icon = icons[m.id] || '💳';
                            return `<option value="${m.id}">${icon} ${m.name}</option>`;
                        }).join('');
                        if (methods.length === 0) {
                            select.innerHTML = '<option value="">Нет доступных методов</option>';
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки методов оплаты:', error);
            }
        }

        // Загрузка системных настроек (активные языки и валюты)
        async function loadSystemSettings() {
            try {
                const response = await fetch('/api/public/system-settings');
                if (response.ok) {
                    const data = await response.json();
                    if (data.active_languages && Array.isArray(data.active_languages)) {
                        activeLanguages = data.active_languages;
                    }
                    if (data.active_currencies && Array.isArray(data.active_currencies)) {
                        activeCurrencies = data.active_currencies;
                    }
                    // Обновляем селекты после загрузки настроек
                    updateLanguageCurrencySelects();
                }
            } catch (error) {
                console.error('Ошибка загрузки системных настроек:', error);
            }
        }

        // Обновление селектов языков и валют на основе активных
        function updateLanguageCurrencySelects() {
            const currencySelect = document.getElementById('currencySelect');
            const languageSelect = document.getElementById('languageSelect');
            
            // Обновляем селект валют
            if (currencySelect) {
                // Используем currentCurrency (из localStorage или userData) вместо currencySelect.value
                const savedCurrency = currentCurrency || localStorage.getItem('preferredCurrency') || 'uah';
                currencySelect.innerHTML = '';
                
                const currencies = [
                    { code: 'uah', label: '₴ UAH' },
                    { code: 'rub', label: '₽ RUB' },
                    { code: 'usd', label: '$ USD' }
                ];
                
                currencies.forEach(curr => {
                    if (activeCurrencies.includes(curr.code)) {
                        const option = document.createElement('option');
                        option.value = curr.code;
                        option.textContent = curr.label;
                        currencySelect.appendChild(option);
                    }
                });
                
                // Устанавливаем сохраненную валюту, если она активна, иначе первое доступное
                if (activeCurrencies.includes(savedCurrency)) {
                    currencySelect.value = savedCurrency;
                    currentCurrency = savedCurrency;
                } else if (activeCurrencies.length > 0) {
                    currencySelect.value = activeCurrencies[0];
                    currentCurrency = activeCurrencies[0];
                }
            }
            
            // Обновляем селект языков
            if (languageSelect) {
                const currentValue = languageSelect.value;
                languageSelect.innerHTML = '';
                
                const languages = [
                    { code: 'ru', label: '🇷🇺 Русский' },
                    { code: 'ua', label: '🇺🇦 Українська' },
                    { code: 'en', label: '🇬🇧 English' },
                    { code: 'cn', label: '🇨🇳 中文' }
                ];
                
                languages.forEach(lang => {
                    if (activeLanguages.includes(lang.code)) {
                        const option = document.createElement('option');
                        option.value = lang.code;
                        option.textContent = lang.label;
                        languageSelect.appendChild(option);
                    }
                });
                
                // Устанавливаем текущее значение, если оно активно, иначе первое доступное
                if (activeLanguages.includes(currentValue)) {
                    languageSelect.value = currentValue;
                } else if (activeLanguages.length > 0) {
                    languageSelect.value = activeLanguages[0];
                    currentLanguage = activeLanguages[0];
                }
            }
        }

        function applyBranding() {
            const brandingHeader = document.getElementById('brandingHeader');
            const brandingLogo = document.getElementById('brandingLogo');
            const brandingTitle = document.getElementById('brandingTitle');
            const brandingSubtitle = document.getElementById('brandingSubtitle');

            console.log('Applying branding:', branding);

            if (branding.site_name) {
                brandingTitle.textContent = branding.site_name;
            }
            if (branding.site_subtitle) {
                brandingSubtitle.textContent = branding.site_subtitle;
            }
            if (branding.logo_url) {
                console.log('Setting logo URL:', branding.logo_url);
                brandingLogo.src = branding.logo_url;
                brandingLogo.classList.remove('hidden');
                brandingLogo.style.cssText = 'display: block !important;';
                
                // Обработка ошибки загрузки изображения
                brandingLogo.onerror = function() {
                    console.error('Failed to load logo:', branding.logo_url);
                    this.style.display = 'none';
                };
                brandingLogo.onload = function() {
                    console.log('Logo loaded successfully');
                };
            }

            if (branding.site_name || branding.site_subtitle || branding.logo_url) {
                brandingHeader.classList.remove('hidden');
                brandingHeader.style.cssText = 'display: flex !important;';
            }
        }

        function toggleServers() {
            serversExpanded = !serversExpanded;
            const serversSection = document.getElementById('serversSection');
            const serversToggle = document.getElementById('serversToggle');
            
            if (serversExpanded) {
                serversSection.classList.remove('collapsed');
                serversSection.classList.add('expanded');
                serversToggle.textContent = '▲';
                serversToggle.classList.add('expanded');
            } else {
                serversSection.classList.remove('expanded');
                serversSection.classList.add('collapsed');
                serversToggle.textContent = '▼';
                serversToggle.classList.remove('expanded');
            }
        }

        function getSubscriptionUrl() {
            // Используем subscriptionUrl из данных пользователя (это ссылка на Remmina subscription page)
            if (userData && userData.subscriptionUrl) {
                return userData.subscriptionUrl;
            }
            // Если нет subscriptionUrl, возвращаем null (кнопка не будет показана)
            return null;
        }

        function switchPage(page) {
            // Скрываем все страницы
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // Показываем выбранную страницу
            const pageElement = document.getElementById(`page${page.charAt(0).toUpperCase() + page.slice(1)}`);
            const navElement = document.getElementById(`nav${page.charAt(0).toUpperCase() + page.slice(1)}`);

            if (pageElement) {
                pageElement.classList.add('active');
            }
            if (navElement) {
                navElement.classList.add('active');
            }

            currentPage = page;

            // Если переключились на страницу серверов, загружаем их если еще не загружены
            if (page === 'servers' && servers.length === 0) {
                loadServers();
            }

            // Опции загружаются на странице тарифов
            if (page === 'tariffs' && !purchaseOptionsLoaded) {
                loadPurchaseOptions();
            }

            // Если переключились на страницу фортуны: нейтральное положение колеса (x1), сброс результата
            if (page === 'casino' && casinoEnabled) {
                var casinoRes = document.getElementById('casinoResult');
                if (casinoRes) {
                    casinoRes.style.display = 'none';
                    casinoRes.textContent = '';
                }
                var centerEl = document.getElementById('casinoWheelCenter');
                if (centerEl) centerEl.textContent = '?';
                var wheelEl = document.getElementById('casinoWheel');
                if (wheelEl) {
                    var segmentDeg = 360 / 7;
                    var idleSector = 3;
                    var idleDeg = (idleSector + 0.5) * segmentDeg;
                    casinoWheelRotation = idleDeg;
                    wheelEl.classList.remove('spinning');
                    wheelEl.style.transition = 'none';
                    wheelEl.style.transform = 'rotate(' + idleDeg + 'deg)';
                }
                updateCasinoPage();
            }

            // Обновляем видимость кнопки "Подключиться"
            updateFloatingButton();
        }

        function updateCasinoPage() {
            if (!casinoEnabled) return;
            const balanceEl = document.getElementById('casinoBalanceDays');
            const betInput = document.getElementById('casinoBetInput');
            const gamesLeftEl = document.getElementById('casinoGamesLeft');
            const days = userData ? (getUserDaysFromData(userData) || 0) : 0;
            if (balanceEl) balanceEl.textContent = days;
            if (betInput && casinoConfig.min_bet != null) {
                betInput.min = casinoConfig.min_bet;
                betInput.max = Math.min(casinoConfig.max_bet || 30, days);
            }
            if (gamesLeftEl && casinoConfig.max_games_per_day != null) {
                gamesLeftEl.textContent = 'Игр в день: до ' + casinoConfig.max_games_per_day;
            }
        }

        function getUserDaysFromData(data) {
            if (!data) return 0;
            const exp = data.expireAt || data.expire_at;
            if (!exp) return 0;
            const end = new Date(exp);
            const now = new Date();
            return Math.max(0, Math.ceil((end - now) / (24 * 60 * 60 * 1000)));
        }

        var CASINO_SECTORS = [0, 0.5, 1, 1.5, 2, 3, 5];

        var WHEEL_SPIN_MS = 4000; // длительность анимации колеса (должна совпадать с CSS .casino-wheel.spinning)

        function spinWheelToMultiplier(multiplier) {
            var wheelEl = document.getElementById('casinoWheel');
            var centerEl = document.getElementById('casinoWheelCenter');
            if (!wheelEl) return;
            var idx = CASINO_SECTORS.indexOf(multiplier);
            if (idx < 0) idx = 0;
            var segmentDeg = 360 / 7;
            // На колесе порядок: 0=x5, 1=x0, 2=x0.5, 3=x1, 4=x1.5, 5=x2, 6=x3 (первый сектор сверху = x5)
            var wheelIdx = (idx + 1) % 7;
            var stopDeg = (wheelIdx + 0.5) * segmentDeg;
            var fullSpins = 5 * 360;
            // При rotate(R) верх viewport показывает сектор под углом (360-R). Чтобы под стрелкой был stopDeg — R = 360 - stopDeg.
            var endRotation = 360 - stopDeg;
            var startRotation = endRotation - fullSpins;
            casinoWheelRotation = endRotation;
            wheelEl.classList.remove('spinning');
            wheelEl.style.transition = 'none';
            wheelEl.style.transform = 'rotate(' + startRotation + 'deg)';
            wheelEl.offsetHeight;
            wheelEl.style.transition = '';
            wheelEl.classList.add('spinning');
            wheelEl.style.transform = 'rotate(' + endRotation + 'deg)';
            if (centerEl) centerEl.textContent = '?';
            setTimeout(function() {
                wheelEl.classList.remove('spinning');
                if (centerEl) centerEl.textContent = 'x' + (multiplier === 0.5 ? '0.5' : multiplier);
            }, WHEEL_SPIN_MS);
        }

        async function casinoSpin() {
            const btn = document.getElementById('casinoSpinBtn');
            const resultEl = document.getElementById('casinoResult');
            const betInput = document.getElementById('casinoBetInput');
            if (!btn || !resultEl || !betInput) return;
            const bet = parseInt(betInput.value, 10) || 1;
            if (bet < (casinoConfig.min_bet || 1) || bet > (casinoConfig.max_bet || 30)) {
                resultEl.style.display = 'block';
                resultEl.className = 'status-message';
                resultEl.style.color = 'var(--danger)';
                resultEl.textContent = 'Ставка от ' + (casinoConfig.min_bet || 1) + ' до ' + (casinoConfig.max_bet || 30) + ' дней';
                return;
            }
            btn.disabled = true;
            resultEl.style.display = 'none';
            try {
                const response = await fetch('/miniapp/casino/play', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData || '', bet: bet })
                });
                const data = await response.json();
                resultEl.style.display = 'block';
                if (!response.ok) {
                    resultEl.className = 'status-message';
                    resultEl.style.color = 'var(--danger)';
                    resultEl.textContent = data.error || 'Ошибка';
                    btn.disabled = false;
                    return;
                }
                var mult = data.multiplier;
                if (typeof mult !== 'number') mult = 0;
                resultEl.style.display = 'block';
                resultEl.style.color = 'var(--tg-theme-text-color, #333)';
                resultEl.textContent = 'Крутим…';
                spinWheelToMultiplier(mult);
                setTimeout(function() {
                    resultEl.style.color = 'var(--success)';
                    resultEl.textContent = 'Множитель: x' + (mult === 0.5 ? '0.5' : mult) + '. ' + (data.win_days > 0 ? 'Выигрыш: +' + data.win_days + ' дн.' : 'Ставка сгорела.') + ' Баланс: ' + data.balance_after + ' дн.';
                    if (userData && data.balance_after != null) {
                        var expDate = new Date();
                        expDate.setTime(expDate.getTime() + data.balance_after * 24 * 60 * 60 * 1000);
                        userData.expireAt = expDate.toISOString();
                    }
                    updateCasinoPage();
                    if (typeof updateSubscriptionStatus === 'function') updateSubscriptionStatus();
                    btn.disabled = false;
                }, typeof WHEEL_SPIN_MS !== 'undefined' ? WHEEL_SPIN_MS : 4000);
                return;
            } catch (e) {
                resultEl.style.display = 'block';
                resultEl.className = 'status-message';
                resultEl.style.color = 'var(--danger)';
                resultEl.textContent = 'Ошибка сети';
            }
            btn.disabled = false;
        }

        function handleConnectClick(event) {
            event.preventDefault();
            event.stopPropagation();
            const url = getSubscriptionUrl();
            if (url) {
                // Открываем subscription URL в Remmina (как в боте)
                tg.openLink(url);
            } else {
                tg.showAlert(t('error') + ': ' + t('notAvailable'));
            }
        }

        function updateFloatingButton() {
            // Обновляем кнопку подключения в блоке статуса подписки
            const connectBtnContainer = document.getElementById('connectButtonContainer');
            const connectBtn = document.getElementById('connectButton');
            const connectBtnText = document.getElementById('connectButtonText');
            
            if (!connectBtnContainer || !connectBtn || !connectBtnText) return;

            // Показываем кнопку только на странице "Информация" и когда подписка активна
            const isOnInfoPage = currentPage === 'info';
            const isActive = userData && userData.activeInternalSquads && userData.activeInternalSquads.length > 0;
            const subscriptionUrl = getSubscriptionUrl(); // Получаем subscriptionUrl для Remmina
            
            // Показываем кнопку только если есть активная подписка И subscriptionUrl (ссылка на Remmina)
            if (isOnInfoPage && isActive && subscriptionUrl) {
                connectBtnContainer.style.display = 'block';
                connectBtnText.textContent = t('connect');
            } else {
                connectBtnContainer.style.display = 'none';
            }
            
            // Скрываем старую плавающую кнопку
            const floatingBtn = document.getElementById('floatingConnectBtn');
            if (floatingBtn) {
                floatingBtn.classList.add('hidden');
            }
        }

        // Загрузка данных
        async function loadData() {
            try {
                const initData = tg.initData || '';
                if (!initData) {
                    throw new Error('Нет данных авторизации');
                }

                // Загружаем брендинг, конфигурацию бота и системные настройки
                await Promise.all([
                    loadBranding(),
                    loadBotConfig(),
                    loadCasinoConfig(),
                    loadSystemSettings(),
                    loadTopupPaymentMethods()
                ]);

                // Загружаем данные подписки
                const subscriptionResponse = await fetch('/miniapp/subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                if (!subscriptionResponse.ok) {
                    // Проверяем, может быть пользователь не зарегистрирован (401 или 404)
                    if (subscriptionResponse.status === 401 || subscriptionResponse.status === 404) {
                        showRegistrationMessage();
                        return;
                    }
                    throw new Error(t('errorLoadingSubscription'));
                }

                const subscriptionData = await subscriptionResponse.json();
                userData = subscriptionData.response || subscriptionData;
                
                // Обрабатываем subscriptionUrl из разных форматов ответа
                if (subscriptionData.subscription_url && !userData.subscriptionUrl) {
                    userData.subscriptionUrl = subscriptionData.subscription_url;
                }
                if (!userData.subscriptionUrl && userData.subscription_url) {
                    userData.subscriptionUrl = userData.subscription_url;
                }
                
                // Проверяем, зарегистрирован ли пользователь
                if (!userData || (!userData.telegram_id && !userData.id)) {
                    // Пользователь не зарегистрирован
                    showRegistrationMessage();
                    return;
                }
                
                console.log('Loaded userData:', userData);
                console.log('referral_code in userData:', userData?.referral_code);
                console.log('Full userData keys:', Object.keys(userData || {}));
                
                // Если referral_code не найден, пробуем получить через /api/client/me
                if (!userData?.referral_code && !userData?.referralCode) {
                    console.log('referral_code not found, trying to fetch from /api/client/me...');
                    try {
                        const initData = tg.initData || '';
                        const telegramId = getUserFromInitData(initData);
                        
                        if (telegramId) {
                            const tokenResponse = await fetch('/api/bot/get-token', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ telegram_id: telegramId })
                            });
                            
                            if (tokenResponse.ok) {
                                const tokenData = await tokenResponse.json();
                                const token = tokenData.token;
                                
                                const userResponse = await fetch('/api/client/me', {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                if (userResponse.ok) {
                                    const userApiData = await userResponse.json();
                                    console.log('Got user data from /api/client/me:', userApiData);
                                    console.log('Full userApiData keys:', Object.keys(userApiData || {}));
                                    
                                    // API возвращает {"response": {...}}, нужно проверить оба варианта
                                    const responseData = userApiData.response || userApiData;
                                    console.log('responseData:', responseData);
                                    console.log('responseData.referral_code:', responseData?.referral_code);
                                    
                                    const referralCode = responseData?.referral_code || responseData?.referralCode || userApiData?.referral_code || userApiData?.referralCode;
                                    console.log('Final referralCode from /api/client/me:', referralCode);
                                    
                                    if (referralCode) {
                                        userData.referral_code = referralCode;
                                        console.log('Set referral_code from /api/client/me:', referralCode);
                                    } else {
                                        console.log('referral_code is null/undefined - user may not have referral_code in database');
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching referral_code from /api/client/me:', error);
                    }
                }
                
                // Устанавливаем язык из данных пользователя
                if (userData?.preferred_lang) {
                    currentLanguage = userData.preferred_lang;
                    document.documentElement.lang = currentLanguage;
                }
                
                // Устанавливаем валюту из данных пользователя (приоритет: данные пользователя > localStorage > дефолт)
                if (userData?.preferred_currency) {
                    currentCurrency = userData.preferred_currency;
                    // Сохраняем в localStorage для следующего открытия
                    localStorage.setItem('preferredCurrency', currentCurrency);
                } else if (localStorage.getItem('preferredCurrency')) {
                    // Если в данных пользователя нет валюты, используем из localStorage
                    currentCurrency = localStorage.getItem('preferredCurrency');
                }
                
                updateSubscriptionInfo();
                updateDashboardWelcome();
                updateFloatingButton();
                updateLanguageUI();
                
                // Реферальная статистика для bento-плиток
                try {
                    const refResp = await fetch('/miniapp/referrals/stats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData || '' })
                    });
                    if (refResp.ok) {
                        const refData = await refResp.json();
                        const rc = document.getElementById('referralCount');
                        const re = document.getElementById('referralEarnings');
                        if (rc) rc.textContent = String(refData.referrals_count ?? refData.total_referrals ?? 0);
                        if (re) {
                            const earn = refData.total_earnings ?? refData.earnings ?? 0;
                            const cur = currentCurrency || 'uah';
                            const sym = cur === 'uah' ? '₴' : cur === 'rub' ? '₽' : '$';
                            re.textContent = (typeof earn === 'number' ? earn.toFixed(2) : earn) + ' ' + sym;
                        }
                    }
                } catch (e) { console.warn('Referral stats load:', e); }
                
                // Обновляем кнопку подключения после обновления информации о подписке
                setTimeout(() => {
                    updateFloatingButton();
                }, 100);
                
                // Обновляем настройки валюты и языка после загрузки данных
                // Используем setTimeout, чтобы убедиться, что DOM элементы уже созданы
                setTimeout(() => {
                    updateSettingsUI();
                }, 100);
                
                // Обновляем реферальную ссылку после загрузки данных
                // Ждем немного, чтобы serverDomain и botConfig успели загрузиться
                setTimeout(() => {
                    updateReferralLink();
                }, 1000);

                // Загружаем тарифы
                const tariffsResponse = await fetch('/miniapp/tariffs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                if (tariffsResponse.ok) {
                    const tariffsData = await tariffsResponse.json();
                    tariffs = tariffsData.tariffs || tariffsData.response || [];
                }

                // Загружаем уровни тарифов (для динамических уровней)
                try {
                    const levelsResp = await fetch('/api/public/tariff-levels', { cache: 'no-store' });
                    if (levelsResp.ok) {
                        const levelsData = await levelsResp.json();
                        tariffLevels = Array.isArray(levelsData) ? levelsData : [];
                    } else {
                        tariffLevels = [];
                    }
                } catch (e) {
                    tariffLevels = [];
                }

                // Загружаем функции тарифов (для отображения в аккордеоне)
                try {
                    const featuresResp = await fetch('/api/public/tariff-features', { cache: 'no-store' });
                    if (featuresResp.ok) {
                        const featuresData = await featuresResp.json();
                        // ожидаем либо { basic: [...] }, либо { features: { basic: [...] } }
                        tariffFeaturesByTier = (featuresData && typeof featuresData === 'object')
                            ? (featuresData.features || featuresData)
                            : {};
                    } else {
                        tariffFeaturesByTier = {};
                    }
                } catch (e) {
                    tariffFeaturesByTier = {};
                }

                renderTariffs();

                // Загружаем конфиги
                await loadConfigs();

                // Загружаем серверы только если на странице серверов
                if (currentPage === 'servers') {
                    await loadServers();
                }

                // Загружаем способы оплаты
                const paymentMethodsResponse = await fetch('/miniapp/payments/methods', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                if (paymentMethodsResponse.ok) {
                    const paymentData = await paymentMethodsResponse.json();
                    paymentMethods = paymentData.methods || [];
                }
                
                // Загружаем курсы валют
                try {
                    const currencyRatesResponse = await fetch('/api/public/currency-rates');
                    if (currencyRatesResponse.ok) {
                        const ratesData = await currencyRatesResponse.json();
                        // API возвращает {rates: {UAH: 40.0, RUB: 100.0, USD: 1.0}}
                        // Сохраняем весь объект ответа для правильной обработки
                        localStorage.setItem('currencyRates', JSON.stringify(ratesData));
                    }
                } catch (error) {
                    console.error('Ошибка загрузки курсов валют:', error);
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
                // Обновляем текст загрузки при смене языка
                const loadingText = document.getElementById('loadingText');
                if (loadingText) {
                    loadingText.textContent = t('loading');
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                // Проверяем, может быть пользователь не зарегистрирован
                if (error.message && (error.message.includes('401') || error.message.includes('Unauthorized') || error.message.includes('не зарегистрирован'))) {
                    showRegistrationMessage();
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error').classList.remove('hidden');
                }
            }
        }
        
        function showRegistrationMessage() {
            // Скрываем контент и показываем сообщение о регистрации
            const content = document.getElementById('content');
            const loading = document.getElementById('loading');
            
            if (loading) loading.classList.add('hidden');
            if (content) {
                content.classList.remove('hidden');
                content.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; padding: 20px; text-align: center;">
                        <div class="card" style="max-width: 380px; width: 100%; padding: 40px 28px;">
                            <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: var(--surface-strong); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                                <svg class="icon" style="width: 40px; height: 40px; color: var(--primary);"><use href="#icon-shield"/></svg>
                            </div>
                            <h2 style="margin-bottom: 12px; color: var(--text-primary); font-size: 22px; font-weight: 700;">${t('registrationRequired')}</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 28px; line-height: 1.6; font-size: 15px;">
                                ${t('registrationMessage')}
                            </p>
                            <button class="btn" onclick="window.open('${botConfig.bot_link_for_miniapp || ''}', '_blank')">
                                <svg class="icon"><use href="#icon-bot"/></svg>
                                ${t('openBot')}
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        let configs = []; // Список конфигов пользователя

        let renameConfigId = null;

        function escapeHtml(value) {
            return String(value ?? '').replace(/[&<>"']/g, (char) => {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return map[char] || char;
            });
        }

        function openRenameConfigModal(configId, currentName) {
            renameConfigId = Number(configId);
            const modal = document.getElementById('renameConfigModal');
            const titleEl = document.getElementById('renameConfigTitle');
            const labelEl = document.getElementById('renameConfigLabel');
            const inputEl = document.getElementById('renameConfigInput');
            const saveBtn = document.getElementById('renameConfigSaveBtn');
            const cancelBtn = document.getElementById('renameConfigCancelBtn');

            if (!modal || !inputEl || !saveBtn || !cancelBtn) return;

            if (titleEl) titleEl.textContent = t('renameConfig');
            if (labelEl) labelEl.textContent = t('enterConfigName');

            inputEl.value = String(currentName ?? '').trim();
            saveBtn.textContent = t('renameConfig');
            cancelBtn.textContent = t('cancel');

            cancelBtn.onclick = () => closeRenameConfigModal();

            saveBtn.onclick = async () => {
                const newName = String(inputEl.value ?? '').trim();
                if (!newName) return;
                await submitRenameConfig(renameConfigId, newName);
            };

            inputEl.onkeydown = async (e) => {
                if (e.key === 'Escape') {
                    closeRenameConfigModal();
                }
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newName = String(inputEl.value ?? '').trim();
                    if (!newName) return;
                    await submitRenameConfig(renameConfigId, newName);
                }
            };

            modal.classList.add('active');
            setTimeout(() => {
                try {
                    inputEl.focus();
                    inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length);
                } catch (e) {}
            }, 50);
        }

        function closeRenameConfigModal() {
            const modal = document.getElementById('renameConfigModal');
            if (modal) modal.classList.remove('active');
            renameConfigId = null;
        }

        function showAlert(message) {
            try {
                if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                    tg.showAlert(String(message));
                } else {
                    alert(String(message));
                }
            } catch (e) {
                alert(String(message));
            }
        }

        function confirmAction(message, okText, destructive = false) {
            return new Promise((resolve) => {
                try {
                    if (typeof tg !== 'undefined' && tg && typeof tg.showPopup === 'function') {
                        tg.showPopup({
                            title: t('myConfigs'),
                            message: String(message),
                            buttons: [
                                { id: 'cancel', type: 'cancel', text: t('cancel') },
                                { id: 'ok', type: destructive ? 'destructive' : 'default', text: String(okText) }
                            ]
                        }, (buttonId) => resolve(buttonId === 'ok'));
                        return;
                    }
                } catch (e) {
                    // ignore and fallback
                }

                resolve(window.confirm(String(message)));
            });
        }

        async function submitRenameConfig(configId, newName) {
            const id = Number(configId);
            if (!id) return;

            try {
                const initData = tg.initData || '';
                const response = await fetch('/miniapp/configs/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData, configId: id, name: String(newName).trim() })
                });

                if (response.ok) {
                    const config = configs.find(c => Number(c.id) === id);
                    if (config) config.config_name = String(newName).trim();
                    closeRenameConfigModal();
                    showAlert(t('configRenamed'));
                    renderConfigs();
                } else {
                    const err = await response.json().catch(() => null);
                    showAlert(err?.detail?.message || t('error'));
                }
            } catch (error) {
                console.error('Ошибка переименования конфига:', error);
                showAlert(t('error'));
            }
        }

        async function loadConfigs() {
            try {
                const initData = tg.initData || '';
                const configsListEl = document.getElementById('configsList');
                
                if (!configsListEl) return;

                configsListEl.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">${t('configsLoading')}</div>`;

                const response = await fetch('/miniapp/configs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                if (response.ok) {
                    const data = await response.json();
                    configs = data.configs || [];
                    renderConfigs();
                } else {
                    configsListEl.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">${t('configsNotFound')}</div>`;
                }
            } catch (error) {
                console.error('Ошибка загрузки конфигов:', error);
                const configsListEl = document.getElementById('configsList');
                if (configsListEl) {
                    configsListEl.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">${t('configsNotFound')}</div>`;
                }
            }
        }

        function renderConfigs() {
            const configsListEl = document.getElementById('configsList');
            if (!configsListEl) return;

            if (!configs || configs.length === 0) {
                configsListEl.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">${t('configsNotFound')}</div>`;
                return;
            }

            configsListEl.innerHTML = configs.map(config => {
                const isActive = config.is_active || false;
                const expireDate = config.expire_at ? new Date(config.expire_at).toLocaleDateString(currentLanguage === 'ru' ? 'ru-RU' : currentLanguage === 'ua' ? 'uk-UA' : currentLanguage === 'en' ? 'en-US' : 'zh-CN') : null;
                const configName = config.config_name || config.name || `Конфиг ${config.id}`;
                const configNameSafe = escapeHtml(configName);
                const renameTitle = escapeHtml(t('renameConfig'));
                const deleteTitle = escapeHtml(t('deleteConfig'));
                // Экранируем URL для безопасного использования в HTML атрибутах
                const safeUrl = config.subscription_url ? config.subscription_url.replace(/'/g, "&#39;").replace(/"/g, "&quot;") : '';
                
                return `
                    <div class="config-card">
                        <div class="config-header">
                            <div class="config-info">
                                <div class="config-name">
                                    ${config.is_primary ? '<svg class="icon icon-sm"><use href="#icon-star"/></svg>' : ''}
                                    ${configNameSafe}
                                </div>
                                <div class="config-status ${isActive ? 'active' : 'inactive'}">
                                    ${isActive ? t('configActive') : t('configInactive')}
                                    ${expireDate ? ` • ${t('expiresAt')} ${expireDate}` : ` • ${t('noExpireDate')}`}
                                </div>
                            </div>
                            ${!config.is_primary ? `
                                <div class="config-toolbar">
                                    <button class="icon-btn config-rename-btn" data-config-id="${config.id}" title="${renameTitle}" aria-label="${renameTitle}">
                                        <svg class="icon icon-sm"><use href="#icon-edit"/></svg>
                                    </button>
                                    <button class="icon-btn icon-btn-danger config-delete-btn" data-config-id="${config.id}" title="${deleteTitle}" aria-label="${deleteTitle}">
                                        <svg class="icon icon-sm"><use href="#icon-trash"/></svg>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="config-actions">
                            ${config.subscription_url ? `
                                <button class="btn btn-sm config-connect-btn" data-url="${safeUrl}">
                                    <svg class="icon icon-sm"><use href="#icon-link"/></svg>
                                    ${t('connectConfig')}
                                </button>
                                <button class="btn btn-secondary btn-sm config-copy-btn" data-url="${safeUrl}">
                                    <svg class="icon icon-sm"><use href="#icon-copy"/></svg>
                                    ${t('copyConfigLink')}
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary btn-sm config-renew-btn" onclick="handleRenewConfig(${config.id})">
                                <svg class="icon icon-sm"><use href="#icon-credit-card"/></svg>
                                ${t('renewConfig')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Привязываем обработчики событий к кнопкам после рендеринга
            configsListEl.querySelectorAll('.config-connect-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    handleConnectConfig(url);
                });
            });
            
            configsListEl.querySelectorAll('.config-copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    handleCopyConfigLink(url);
                });
            });

            configsListEl.querySelectorAll('.config-rename-btn').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    const id = this.getAttribute('data-config-id');
                    handleRenameConfig(id);
                });
            });

            configsListEl.querySelectorAll('.config-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    const id = this.getAttribute('data-config-id');
                    handleDeleteConfig(id);
                });
            });
        }

        async function handleRenameConfig(configId) {
            const id = Number(configId);
            if (!id) return;

            const config = configs.find(c => Number(c.id) === id);
            if (!config) return;

            if (config.is_primary) {
                showAlert(t('cannotRenamePrimaryConfig'));
                return;
            }

            const currentName = config.config_name || config.name || `Конфиг ${config.id}`;
            openRenameConfigModal(id, currentName);
        }

        async function handleDeleteConfig(configId) {
            const id = Number(configId);
            if (!id) return;

            const config = configs.find(c => Number(c.id) === id);
            if (!config) return;

            if (config.is_primary) {
                showAlert(t('cannotDeletePrimaryConfig'));
                return;
            }

            const ok = await confirmAction(t('confirmDeleteConfig'), t('deleteConfig'), true);
            if (!ok) return;

            try {
                const initData = tg.initData || '';
                const response = await fetch('/miniapp/configs/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData, configId: id })
                });

                if (response.ok) {
                    showAlert(t('configDeleted'));
                    await loadConfigs();
                } else {
                    const err = await response.json().catch(() => null);
                    showAlert(err?.detail?.message || t('error'));
                }
            } catch (error) {
                console.error('Ошибка удаления конфига:', error);
                showAlert(t('error'));
            }
        }

        function handleAddConfig() {
            // Открываем страницу тарифов с флагом создания нового конфига
            // Конфиг будет создан автоматически после успешной оплаты
            selectedConfigId = null; // Сбрасываем выбранный конфиг
            createNewConfig = true; // Устанавливаем флаг создания нового конфига
            switchPage('tariffs');
            
            // Прокручиваем к тарифам
            setTimeout(() => {
                const tariffsPage = document.getElementById('pageTariffs');
                if (tariffsPage) {
                    tariffsPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function handleRenewConfig(configId) {
            // Переходим на страницу тарифов и сохраняем config_id для использования при оплате
            selectedConfigId = configId;
            switchPage('tariffs');
            
            // Прокручиваем к тарифам
            setTimeout(() => {
                const tariffsPage = document.getElementById('pageTariffs');
                if (tariffsPage) {
                    tariffsPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function handleConnectConfig(subscriptionUrl) {
            // Открываем ссылку для подключения
            if (!subscriptionUrl) {
                if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                    tg.showAlert(t('noSubscriptionUrl'));
                } else {
                    alert(t('noSubscriptionUrl'));
                }
                return;
            }
            
            try {
                if (typeof tg !== 'undefined' && tg && tg.openLink) {
                    tg.openLink(subscriptionUrl);
                } else {
                    window.open(subscriptionUrl, '_blank');
                }
            } catch (error) {
                console.error('Error opening link:', error);
                // Fallback: открываем в новом окне
                window.open(subscriptionUrl, '_blank');
            }
        }

        async function handleCopyConfigLink(subscriptionUrl) {
            // Копируем ссылку в буфер обмена
            if (!subscriptionUrl) {
                if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                    tg.showAlert(t('noSubscriptionUrl'));
                } else {
                    alert(t('noSubscriptionUrl'));
                }
                return;
            }

            try {
                // Используем Clipboard API если доступен
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(subscriptionUrl);
                    if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                        tg.showAlert(t('linkCopied'));
                    } else {
                        alert(t('linkCopied'));
                    }
                } else {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = subscriptionUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                                tg.showAlert(t('linkCopied'));
                            } else {
                                alert(t('linkCopied'));
                            }
                        } else {
                            throw new Error('Copy command failed');
                        }
                    } catch (err) {
                        console.error('Error copying:', err);
                        if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                            tg.showAlert(t('errorCopy'));
                        } else {
                            alert(t('errorCopy'));
                        }
                    }
                    document.body.removeChild(textArea);
                }
            } catch (error) {
                console.error('Error copying link:', error);
                if (typeof tg !== 'undefined' && tg && tg.showAlert) {
                    tg.showAlert(t('errorCopy'));
                } else {
                    alert(t('errorCopy'));
                }
            }
        }

        async function loadServers() {
            try {
                const initData = tg.initData || '';
                
                if (!userData || !userData.activeInternalSquads || userData.activeInternalSquads.length === 0) {
                    document.getElementById('serversList').innerHTML = `<div class="error">${t('activateSubscription')}</div>`;
                    return;
                }

                // Загружаем серверы через miniapp эндпоинт
                const response = await fetch('/miniapp/nodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });

                if (response.ok) {
                    const data = await response.json();
                    servers = data.response?.activeNodes || data.activeNodes || [];
                    renderServers();
                } else {
                    document.getElementById('serversList').innerHTML = `<div class="error">${t('errorLoadingServers')}</div>`;
                }
            } catch (error) {
                console.error('Ошибка загрузки серверов:', error);
                document.getElementById('serversList').innerHTML = `<div class="error">${t('errorLoadingServers')}</div>`;
            }
        }

        function updateDashboardWelcome() {
            const titleEl = document.getElementById('dashboardWelcomeTitle');
            const subtitleEl = document.getElementById('dashboardWelcomeSubtitle');
            if (!titleEl || !subtitleEl) return;
            const name = (userData && (userData.first_name || userData.firstName || userData.username)) ? (userData.first_name || userData.firstName || userData.username) : '';
            titleEl.textContent = name ? (t('welcomeName') || 'Добро пожаловать, ').replace('{name}', name) : (t('welcome') || 'Добро пожаловать');
            subtitleEl.textContent = t('yourSubscription') || 'Ваша подписка';
        }

        function updateSubscriptionInfo() {
            if (!userData) return;

            const isActive = userData.activeInternalSquads && userData.activeInternalSquads.length > 0;
            const statusBadge = document.getElementById('subscriptionStatus');
            const expireDateEl = document.getElementById('expireDate');
            const daysLeftEl = document.getElementById('daysLeft');
            const daysBentoEl = document.getElementById('subscriptionDaysBento');
            const devicesEl = document.getElementById('devicesValue');
            const trafficEl = document.getElementById('traffic');
            const trafficProgress = document.getElementById('trafficProgress');
            const trafficProgressFill = document.getElementById('trafficProgressFill');
            const userEmailEl = document.getElementById('userEmail');
            const userPasswordEl = document.getElementById('userPassword');
            const connectContainer = document.getElementById('connectButtonContainer');
            const noConnectActions = document.getElementById('subscriptionCardActionsNoConnect');

            if (isActive) {
                statusBadge.innerHTML = `<span class="status-dot online"></span>${t('active')}`;
                statusBadge.className = 'status-badge status-active';

                if (userData.expireAt) {
                    const expireDate = new Date(userData.expireAt);
                    const daysText = (() => {
                        const now = new Date();
                        const daysLeft = Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24));
                        return daysLeft > 0 ? `${daysLeft} ${t('days')}` : t('expired');
                    })();
                    expireDateEl.textContent = expireDate.toLocaleDateString(currentLanguage === 'ru' ? 'ru-RU' : currentLanguage === 'ua' ? 'uk-UA' : currentLanguage === 'en' ? 'en-US' : 'zh-CN');
                    daysLeftEl.textContent = daysText;
                    if (daysBentoEl) daysBentoEl.textContent = daysText;
                }

                // Устройств из тарифа
                const hwidLimit = userData.hwidDeviceLimit;
                if (devicesEl) {
                    if (hwidLimit != null) {
                        if (hwidLimit === -1 || hwidLimit >= 100) {
                            devicesEl.textContent = t('devices_unlimited');
                        } else {
                            devicesEl.textContent = `${hwidLimit} ${t('devices_available')}`;
                        }
                    } else {
                        devicesEl.textContent = '-';
                    }
                }

                const usedTraffic = (userData.usedTrafficBytes ?? userData.traffic_used ?? 0) || 0;
                const limitTraffic = (userData.trafficLimitBytes ?? userData.traffic_limit ?? 0) || 0;

                if (limitTraffic === 0) {
                    trafficEl.textContent = t('unlimited');
                    trafficProgress.classList.add('hidden');
                } else {
                    const usedGB = (usedTraffic / (1024 ** 3)).toFixed(2);
                    const limitGB = (limitTraffic / (1024 ** 3)).toFixed(2);
                    const percentage = (usedTraffic / limitTraffic * 100).toFixed(0);
                    trafficEl.textContent = `${usedGB} / ${limitGB} GB`;
                    trafficProgress.classList.remove('hidden');
                    trafficProgressFill.style.width = `${Math.min(percentage, 100)}%`;
                }
            } else {
                statusBadge.innerHTML = `<span class="status-dot offline"></span>${t('inactive')}`;
                statusBadge.className = 'status-badge status-inactive';
                expireDateEl.textContent = '-';
                daysLeftEl.textContent = '-';
                if (daysBentoEl) daysBentoEl.textContent = t('inactive') || 'Неактивна';
                if (devicesEl) devicesEl.textContent = '-';
                trafficEl.textContent = '-';
                trafficProgress.classList.add('hidden');
            }

            var subUrl = getSubscriptionUrl && getSubscriptionUrl();
            if (connectContainer) connectContainer.style.display = (isActive && subUrl) ? 'grid' : 'none';
            if (noConnectActions) noConnectActions.style.display = (isActive && !subUrl) || !isActive ? 'grid' : 'none';

            // Обновляем email и пароль
            if (userEmailEl) {
                userEmailEl.textContent = userData.email || '-';
            }
            if (userPasswordEl) {
                userPasswordEl.textContent = userData.password || '-';
            }
            
            // Обновляем баланс с конвертацией валюты
            const userBalanceEl = document.getElementById('userBalance');
            const balanceDisplayEl = document.getElementById('balanceDisplay');
            
            // Используем currentCurrency для отображения (может отличаться от preferred_currency)
            const displayCurrency = currentCurrency || userData.preferred_currency || 'uah';
            const currencySymbol = displayCurrency === 'uah' ? '₴' : displayCurrency === 'rub' ? '₽' : '$';
            
            // Получаем баланс в USD из userData
            const balanceUsd = userData.balance_usd || (userData.balance && displayCurrency === 'usd' ? userData.balance : 0) || 0;
            
            // Конвертируем баланс в выбранную валюту
            let balance = balanceUsd;
            if (displayCurrency !== 'usd' && balanceUsd > 0) {
                // Получаем курсы валют из localStorage или используем дефолтные
                try {
                    const currencyRatesStr = localStorage.getItem('currencyRates');
                    if (currencyRatesStr) {
                        const currencyRatesData = JSON.parse(currencyRatesStr);
                        // API возвращает {rates: {UAH: 40.0, RUB: 100.0, USD: 1.0}} или просто объект
                        const currencyRates = currencyRatesData.rates || currencyRatesData;
                        const currencyKey = displayCurrency.toUpperCase();
                        const rate = currencyRates[currencyKey];
                        
                        if (rate && typeof rate === 'number') {
                            balance = balanceUsd * rate;
                        } else {
                            // Fallback на дефолтные курсы
                            const defaultRate = displayCurrency === 'uah' ? 40 : displayCurrency === 'rub' ? 100 : 1;
                            balance = balanceUsd * defaultRate;
                        }
                    } else {
                        // Fallback на дефолтные курсы
                        const defaultRate = displayCurrency === 'uah' ? 40 : displayCurrency === 'rub' ? 100 : 1;
                        balance = balanceUsd * defaultRate;
                    }
                } catch (error) {
                    console.error('Ошибка конвертации баланса:', error);
                    // Fallback на дефолтные курсы
                    const defaultRate = displayCurrency === 'uah' ? 40 : displayCurrency === 'rub' ? 100 : 1;
                    balance = balanceUsd * defaultRate;
                }
            }
            
            if (userBalanceEl) {
                userBalanceEl.textContent = `${balance.toFixed(2)} ${currencySymbol}`;
            }
            if (balanceDisplayEl) {
                balanceDisplayEl.textContent = `${balance.toFixed(2)} ${currencySymbol}`;
            }
            
            // Обновляем кнопку подключения
            updateFloatingButton();
                // Если пароль не найден в userData, загружаем его через API
                if (!userData.password) {
                    loadUserPassword();
                } else {
                    userPasswordEl.textContent = userData.password;
                }
            }

            // Обновляем реферальную ссылку
            updateReferralLink();

            // Обновляем настройки валюты и языка
            updateSettingsUI();
            
            // Обновляем язык интерфейса
            if (userData?.preferred_lang) {
                currentLanguage = userData.preferred_lang;
                document.documentElement.lang = currentLanguage;
                updateLanguageUI();
            }
        

        function updateSettingsUI() {
            // Устанавливаем текущую валюту (приоритет: данные пользователя > localStorage > дефолт)
            if (userData?.preferred_currency) {
                currentCurrency = userData.preferred_currency;
                localStorage.setItem('preferredCurrency', currentCurrency);
            } else if (localStorage.getItem('preferredCurrency')) {
                currentCurrency = localStorage.getItem('preferredCurrency');
            }
            
            // Проверяем, что валюта активна, иначе выбираем первую доступную
            if (!activeCurrencies.includes(currentCurrency) && activeCurrencies.length > 0) {
                currentCurrency = activeCurrencies[0];
                localStorage.setItem('preferredCurrency', currentCurrency);
            }

            // Устанавливаем текущий язык (приоритет: данные пользователя > localStorage > дефолт)
            if (userData?.preferred_lang) {
                currentLanguage = userData.preferred_lang;
                localStorage.setItem('preferredLanguage', currentLanguage);
            } else if (localStorage.getItem('preferredLanguage')) {
                currentLanguage = localStorage.getItem('preferredLanguage');
            }
            
            // Проверяем, что язык активен, иначе выбираем первый доступный
            if (!activeLanguages.includes(currentLanguage) && activeLanguages.length > 0) {
                currentLanguage = activeLanguages[0];
                localStorage.setItem('preferredLanguage', currentLanguage);
            }
            
            // Обновляем селекты (они уже будут содержать только активные опции)
            updateLanguageCurrencySelects();
        }

        function getServerStatus(server) {
            // Проверяем различные поля для определения статуса сервера
            if (server.isNodeOnline !== undefined && server.isNodeOnline !== null) {
                return server.isNodeOnline;
            }
            if (server.isOnline !== undefined && server.isOnline !== null) {
                return server.isOnline;
            }
            if (server.isActive !== undefined && server.isActive !== null) {
                return server.isActive;
            }
            if (server.enabled !== undefined && server.enabled !== null) {
                return server.enabled;
            }
            if (server.status) {
                const status = String(server.status).toLowerCase().trim();
                return status === 'online' || status === 'active' || status === 'running' || status === 'healthy' || status === 'enabled';
            }
            // По умолчанию считаем сервер онлайн, если нет явного указания на offline
            return true;
        }

        function renderServers() {
            const serversList = document.getElementById('serversList');
            
            // Update subscription progress on servers page
            updateServersSubscriptionProgress();
            
            if (servers.length === 0) {
                serversList.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">${t('serversNotFound')}</div>`;
                return;
            }

            serversList.innerHTML = servers.map((server, index) => {
                const isOnline = getServerStatus(server);
                const statusText = isOnline ? 'Online' : 'Offline';
                
                // Get protocol (default to VLESS if not specified)
                const protocol = server.protocol || server.type || 'VLESS';
                
                // Generate random-ish but consistent load based on server name/index
                const baseLoad = ((server.nodeName || '').length * 7 + index * 13) % 60;
                const load = isOnline ? Math.min(85, Math.max(15, baseLoad + Math.floor(Math.random() * 20))) : 0;
                
                // Load level for styling
                const loadLevel = load > 70 ? 'high' : load < 40 ? 'low' : '';
                
                // Country flag emoji based on country code
                const countryCode = server.countryCode || '';
                const flagEmoji = getCountryFlag(countryCode);
                
                // Random speed from 1 to 10 Gb/s
                const randomSpeed = Math.floor(Math.random() * 10) + 1;
                const speed = `${randomSpeed} Gb/s`;
                
                return `
                    <div class="server-card">
                        <div class="server-header">
                            <div class="server-main">
                                <div class="server-icon">
                                    <svg class="icon"><use href="#icon-server"/></svg>
                                </div>
                                <div class="server-info">
                                    <div class="server-name">
                                        ${server.nodeName || 'Unknown'}
                                        <span class="server-protocol">
                                            <svg class="icon icon-sm" style="width: 10px; height: 10px;"><use href="#icon-zap"/></svg>
                                            ${protocol}
                                        </span>
                                    </div>
                                    <div class="server-region">
                                        <span style="color: var(--accent-green); font-weight: 600;">⚡ ${speed}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="server-status-badge ${isOnline ? 'online' : 'offline'}">
                                <span class="server-status-dot"></span>
                                ${statusText}
                            </div>
                        </div>
                        <div class="server-stats">
                            <div class="server-stat">
                                <div class="server-stat-header">
                                    <span class="server-stat-label">Загрузка</span>
                                    <span class="server-stat-value">${load}%</span>
                                </div>
                                <div class="server-progress">
                                    <div class="server-progress-fill load ${loadLevel}" style="width: ${load}%;"></div>
                                </div>
                            </div>
                            <div class="server-stat">
                                <div class="server-stat-header">
                                    <span class="server-stat-label">Пинг</span>
                                    <span class="server-stat-value">${isOnline ? Math.floor(20 + Math.random() * 80) : '-'} ms</span>
                                </div>
                                <div class="server-progress">
                                    <div class="server-progress-fill load low" style="width: ${isOnline ? Math.floor(20 + Math.random() * 40) : 0}%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Helper function to get country flag emoji
        function getCountryFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) return '🌍';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt(0));
            return String.fromCodePoint(...codePoints);
        }

        // Update subscription progress on servers page
        function updateServersSubscriptionProgress() {
            const subscriptionCard = document.getElementById('serversSubscriptionCard');
            const daysLeftEl = document.getElementById('subscriptionDaysLeft');
            const progressFill = document.getElementById('subscriptionProgressFill');
            
            if (!subscriptionCard || !userData) return;
            
            const isActive = userData.activeInternalSquads && userData.activeInternalSquads.length > 0;
            
            if (!isActive) {
                subscriptionCard.style.display = 'none';
                return;
            }
            
            subscriptionCard.style.display = 'block';
            
            if (userData.expireAt) {
                const expireDate = new Date(userData.expireAt);
                const now = new Date();
                const daysLeft = Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24));
                
                // Полоса "до окончания" — считаем от текущего оставшегося периода:
                // если сейчас осталось N дней, то N дней = 100%, дальше уменьшается (N-1, N-2 ...).
                const totalKey = 'serversSubscriptionTotalDays';
                let totalDays = 0;
                try {
                    totalDays = parseInt(localStorage.getItem(totalKey) || '0', 10) || 0;
                } catch (_) {
                    totalDays = 0;
                }
                
                // Инициализация/обновление базы шкалы: если подписку продлили (daysLeft вырос) — сбрасываем базу
                if (daysLeft > 0 && (!totalDays || totalDays <= 0 || daysLeft > totalDays)) {
                    totalDays = daysLeft;
                    try { localStorage.setItem(totalKey, String(totalDays)); } catch (_) {}
                }
                
                // Если подписка закончилась — шкала не нужна
                if (daysLeft <= 0) {
                    totalDays = 1;
                }
                
                const progressPercent = Math.max(0, Math.min(100, (daysLeft / totalDays) * 100));
                
                if (daysLeftEl) {
                    daysLeftEl.textContent = daysLeft > 0 ? `${daysLeft} ${t('days')}` : t('expired');
                }
                
                if (progressFill) {
                    progressFill.style.width = `${progressPercent}%`;
                    progressFill.classList.remove('warning', 'danger');
                    
                    if (daysLeft <= 3) {
                        progressFill.classList.add('danger');
                    } else if (daysLeft <= 7) {
                        progressFill.classList.add('warning');
                    }
                }
            }
        }

        function getTariffTier(tariff) {
            // Если tier указан в тарифе, используем его (любой код)
            if (tariff && tariff.tier) {
                return String(tariff.tier).toLowerCase();
            }
            // Иначе определяем автоматически по длительности (обратная совместимость для 3 базовых)
            const duration = tariff.duration_days || 0;
            if (duration >= 180) return 'elite';
            if (duration >= 90) return 'pro';
            return 'basic';
        }

        function getTariffLevelsOrdered() {
            if (Array.isArray(tariffLevels) && tariffLevels.length > 0) {
                return [...tariffLevels].sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
            }
            // fallback на старые названия из брендинга
            const basicName = (branding && branding.tariff_tier_basic_name) ? branding.tariff_tier_basic_name : t('basic');
            const proName = (branding && branding.tariff_tier_pro_name) ? branding.tariff_tier_pro_name : t('premium');
            const eliteName = (branding && branding.tariff_tier_elite_name) ? branding.tariff_tier_elite_name : t('elite');
            return [
                { code: 'basic', name: basicName, display_order: 1 },
                { code: 'pro', name: proName, display_order: 2 },
                { code: 'elite', name: eliteName, display_order: 3 },
            ];
        }

        function getTierFeatures(tierCode) {
            if (!tierCode) return [];
            const data = tariffFeaturesByTier || {};
            const list = data[String(tierCode).toLowerCase()];
            return Array.isArray(list) ? list : [];
        }

        function renderTierFeatures(tierCode) {
            const list = getTierFeatures(tierCode);
            if (!list.length) return '';

            const itemsHtml = list.map((feature) => {
                if (typeof feature === 'string') {
                    const name = escapeHtml(feature);
                    return `<div class="tariff-feature-item"><span class="ff-icon">✓</span><span>${name}</span></div>`;
                }
                if (!feature || typeof feature !== 'object') return '';

                const icon = escapeHtml(feature.icon || '✓');
                const name = escapeHtml(feature.name || feature.title || feature.key || 'Feature');
                const desc = escapeHtml(feature.description || feature.value || '');

                const text = desc ? `<strong>${name}</strong> — ${desc}` : `<strong>${name}</strong>`;
                return `<div class="tariff-feature-item"><span class="ff-icon">${icon}</span><span>${text}</span></div>`;
            }).join('');

            return `
                <div class="tariff-features-box">
                    <div class="tariff-features-title">✨ ${escapeHtml(t('tariffFeaturesTitle'))}</div>
                    <div class="tariff-features-list">${itemsHtml}</div>
                </div>
            `;
        }

        function toggleTariffTier(tierCode) {
            const code = String(tierCode || '').toLowerCase();
            if (!code) return;

            // close all
            document.querySelectorAll('.tariff-accordion').forEach((el) => {
                el.classList.remove('open');
            });

            // toggle selected
            const el = document.querySelector(`.tariff-accordion[data-tier="${code}"]`);
            if (!el) return;

            if (openTariffTier === code) {
                openTariffTier = null;
                el.classList.remove('open');
                return;
            }

            openTariffTier = code;
            el.classList.add('open');
            // scroll a bit into view for UX
            try { el.scrollIntoView({ block: 'start', behavior: 'smooth' }); } catch (_) {}
        }

        function renderTariffs() {
            const tariffsList = document.getElementById('tariffsList');
            
            if (tariffs.length === 0) {
                tariffsList.innerHTML = `<div class="error">${t('tariffsNotFound')}</div>`;
                return;
            }

            // Получаем валюту пользователя (используем текущую выбранную валюту)
            const currency = currentCurrency || userData?.preferred_currency || 'uah';
            const currencyMap = {
                'uah': { field: 'price_uah', symbol: '₴' },
                'rub': { field: 'price_rub', symbol: '₽' },
                'usd': { field: 'price_usd', symbol: '$' }
            };
            const currencyConfig = currencyMap[currency] || currencyMap['uah'];

            const levels = getTariffLevelsOrdered();
            const groups = {};
            levels.forEach((l) => { if (l && l.code) groups[l.code] = []; });

            // группируем по tier (любые коды)
            tariffs.forEach((tariff) => {
                const tier = getTariffTier(tariff);
                if (!groups[tier]) groups[tier] = [];
                groups[tier].push(tariff);
            });

            // Добавляем “лишние” уровни, если tier пришел, но уровня нет в tariffLevels
            const knownCodes = new Set(levels.map(l => l.code));
            Object.keys(groups).forEach((code) => {
                if (!knownCodes.has(code)) {
                    levels.push({ code, name: code, display_order: 999 });
                }
            });

            // Сортируем тарифы по длительности внутри каждой категории
            Object.keys(groups).forEach((code) => {
                groups[code].sort((a, b) => (a.duration_days || 0) - (b.duration_days || 0));
            });

            let html = '';
            
            // Функция для расчета финальной цены с учетом промокода
            const calculateFinalPrice = (basePrice) => {
                if (!appliedPromo) return basePrice;
                if (appliedPromo.type === 'PERCENT') {
                    return Math.max(0, basePrice * (1 - appliedPromo.value / 100));
                } else if (appliedPromo.type === 'FIXED') {
                    return Math.max(0, basePrice - appliedPromo.value);
                }
                return basePrice;
            };
            
            const levelIcons = ['#icon-zap', '#icon-star', '#icon-crown', '#icon-star', '#icon-star'];

            levels.forEach((level, idx) => {
                const code = level.code;
                const list = groups[code] || [];
                if (!list.length) return;
                const iconHref = levelIcons[idx] || '#icon-star';
                const levelName = level.name || code;

                const safeCode = escapeHtml(code);
                const safeName = escapeHtml(levelName);
                const count = list.length;
                const isOpen = openTariffTier === String(code).toLowerCase();

                // Находим минимальную цену для этого tier
                const minPrice = Math.min(...list.map(t => t[currencyConfig.field] || 0));
                const finalMinPrice = calculateFinalPrice(minPrice);
                const hasDiscount = appliedPromo && finalMinPrice < minPrice;
                
                // Получаем данные первого тарифа для отображения общих характеристик tier
                const firstTariff = list[0];
                const trafficLimit = Number(firstTariff.traffic_limit_bytes) || 0;
                
                // Проверяем deviceLimit - ищем во всех тарифах tier, так как может отличаться
                let deviceLimit = null;
                for (const tariff of list) {
                    const limit = tariff.hwid_device_limit;
                    if (limit !== null && limit !== undefined && limit !== '') {
                        const numLimit = Number(limit);
                        if (!isNaN(numLimit) && numLimit > 0) {
                            deviceLimit = numLimit;
                            break; // Берем первое найденное значение > 0
                        }
                    }
                }
                
                // Форматируем трафик
                let trafficText = '∞';
                if (trafficLimit > 0) {
                    const trafficGB = (trafficLimit / (1024 ** 3)).toFixed(0);
                    trafficText = `${trafficGB} GB`;
                }
                
                // Форматируем устройства - если есть значение и оно > 0, показываем число, иначе ∞
                let deviceText = '';
                if (deviceLimit !== null && deviceLimit > 0) {
                    deviceText = `${deviceLimit} устр.`;
                } else {
                    deviceText = '∞';
                }

                const priceHtml = hasDiscount
                    ? `<span class="tariff-price-old">${minPrice.toFixed(2)} ${currencyConfig.symbol}</span><span>${finalMinPrice.toFixed(2)} ${currencyConfig.symbol}</span>`
                    : `${finalMinPrice.toFixed(2)} ${currencyConfig.symbol}`;
                html += `
                    <div class="tariff-accordion ${isOpen ? 'open' : ''}" data-tier="${safeCode}">
                        <button class="tariff-accordion-header" onclick="openTariffDetailsModal('${safeCode}')" type="button" style="width: 100%; text-align: left; padding: 12px 14px; background: var(--glass-bg); border-radius: var(--radius); border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.25s ease; box-shadow: var(--shadow-xs);">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div>
                                    <div style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 6px;">
                                        ${safeName}
                                    </div>
                                    <div class="tariff-accordion-traffic-row" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 6px;">
                                        <span style="min-width: 0;">Трафик: <span style="color: var(--primary); font-weight: 600;">${trafficText}</span></span>
                                        <span class="tariff-accordion-devices" style="color: var(--text-muted);">Устр.: ${deviceText}</span>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--glass-border); padding-top: 8px; display: flex; justify-content: space-between; align-items: flex-end; gap: 12px;">
                                    <div class="tariff-accordion-price-block">
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px;">от</div>
                                        <div class="tariff-accordion-price-line" style="font-size: 18px; font-weight: 700; color: var(--primary); font-family: 'JetBrains Mono', monospace;">
                                            ${priceHtml}
                                        </div>
                                    </div>
                                    <button class="btn" onclick="event.stopPropagation(); openTariffDetailsModal('${safeCode}')" style="flex-shrink: 0; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); padding: 8px 18px; font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap;">
                                        Купить
                                    </button>
                                </div>
                            </div>
                        </button>
                    </div>
                `;
            });

            tariffsList.innerHTML = html || `<div class="error">${t('tariffsNotFound')}</div>`;
        }

        async function loadPurchaseOptions() {
            try {
                const initData = tg.initData || '';
                if (!initData) return;

                const list = document.getElementById('optionsList');
                const loadingEl = document.getElementById('optionsLoadingText');
                if (loadingEl) loadingEl.textContent = 'Загрузка опций...';
                if (list && !loadingEl) list.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">Загрузка опций...</div>`;

                const resp = await fetch('/miniapp/purchase-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData })
                });
                const data = await resp.json().catch(() => ({}));
                const grouped = data?.options || {};
                purchaseOptions = {
                    traffic: Array.isArray(grouped.traffic) ? grouped.traffic : [],
                    devices: Array.isArray(grouped.devices) ? grouped.devices : [],
                    squad: Array.isArray(grouped.squad) ? grouped.squad : []
                };
                purchaseOptionsLoaded = true;
                renderPurchaseOptions();
            } catch (e) {
                console.error('loadPurchaseOptions error', e);
                const list = document.getElementById('optionsList');
                if (list) list.innerHTML = `<div class="error">${t('errorLoading')}</div>`;
            }
        }

        function renderPurchaseOptions() {
            const list = document.getElementById('optionsList');
            if (!list) return;

            const hasAny = (purchaseOptions.traffic?.length || 0) + (purchaseOptions.devices?.length || 0) + (purchaseOptions.squad?.length || 0);
            if (!hasAny) {
                list.innerHTML = `<div class="error">${t('tariffsNotFound')}</div>`;
                return;
            }

            const currency = currentCurrency || userData?.preferred_currency || 'uah';
            const currencyMap = {
                'uah': { field: 'price_uah', symbol: '₴' },
                'rub': { field: 'price_rub', symbol: '₽' },
                'usd': { field: 'price_usd', symbol: '$' }
            };
            const currencyConfig = currencyMap[currency] || currencyMap['uah'];

            const groups = [
                { key: 'traffic', title: 'Трафик', iconId: 'icon-activity', items: purchaseOptions.traffic || [] },
                { key: 'devices', title: 'Устройства', iconId: 'icon-server', items: purchaseOptions.devices || [] },
                { key: 'squad', title: 'Сквады', iconId: 'icon-users', items: purchaseOptions.squad || [] },
            ];

            let html = '';
            groups.forEach((g) => {
                if (!g.items.length) return;
                html += `
                    <div class="option-group">
                        <div class="option-group-header">
                            <div class="option-group-icon"><svg class="icon"><use href="#${g.iconId}"/></svg></div>
                            <span class="option-group-title">${escapeHtml(g.title)}</span>
                            <span class="option-group-count">${g.items.length} шт.</span>
                        </div>
                `;
                html += g.items.map((opt) => {
                    const price = Number(opt[currencyConfig.field] || 0);
                    const desc = opt.description ? String(opt.description) : '';
                    const value = opt.value ? String(opt.value) : '';
                    const unit = opt.unit ? String(opt.unit) : '';
                    const badge = value ? `${value}${unit ? (' ' + unit) : ''}` : '';
                    const name = escapeHtml(opt.name || 'Опция');
                    const descLine = [badge, desc].filter(Boolean).join(' • ');

                    return `
                        <div class="option-item" onclick="selectPurchaseOption(${opt.id})" role="button" tabindex="0">
                            <div class="option-item-icon"><svg class="icon"><use href="#icon-gift"/></svg></div>
                            <div class="option-item-body">
                                <div class="option-item-name">${name}</div>
                                ${descLine ? `<div class="option-item-desc">${escapeHtml(descLine)}</div>` : ''}
                            </div>
                            <div class="option-item-price">${price.toFixed(2)} ${currencyConfig.symbol}</div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            });

            list.innerHTML = html;
        }

        function selectPurchaseOption(optionId) {
            selectedOptionId = optionId;
            selectedTariffId = null;
            openPaymentModal();
        }

        function openTariffsModal() {
            const modal = document.getElementById('tariffsModal');
            const tariffsModalList = document.getElementById('tariffsModalList');
            
            // Получаем валюту пользователя (используем текущую выбранную валюту)
            const currency = currentCurrency || userData?.preferred_currency || 'uah';
            const currencyMap = {
                'uah': { field: 'price_uah', symbol: '₴' },
                'rub': { field: 'price_rub', symbol: '₽' },
                'usd': { field: 'price_usd', symbol: '$' }
            };
            const currencyConfig = currencyMap[currency] || currencyMap['uah'];

            const levels = getTariffLevelsOrdered();
            const groups = {};
            levels.forEach((l) => { if (l && l.code) groups[l.code] = []; });

            tariffs.forEach((tariff) => {
                const tier = getTariffTier(tariff);
                if (!groups[tier]) groups[tier] = [];
                groups[tier].push(tariff);
            });

            const knownCodes = new Set(levels.map(l => l.code));
            Object.keys(groups).forEach((code) => {
                if (!knownCodes.has(code)) {
                    levels.push({ code, name: code, display_order: 999 });
                }
            });

            Object.keys(groups).forEach((code) => {
                groups[code].sort((a, b) => (a.duration_days || 0) - (b.duration_days || 0));
            });

            const levelIcons = ['#icon-zap', '#icon-star', '#icon-crown', '#icon-star', '#icon-star'];
            let html = '';

            levels.forEach((level, idx) => {
                const code = level.code;
                const list = groups[code] || [];
                if (!list.length) return;
                const iconHref = levelIcons[idx] || '#icon-star';
                const levelName = level.name || code;
                html += `<div style="margin-bottom: 24px;"><div class="section-label" style="font-size: 14px;"><svg class="icon icon-sm"><use href="${iconHref}"/></svg> ${levelName}</div>`;
                html += list.map(tariff => {
                    const price = Number(tariff[currencyConfig.field]) || 0;
                    const finalPrice = getFinalTariffPrice(price);
                    const hasDiscount = appliedPromo && finalPrice < price;
                    const priceDisplay = hasDiscount
                        ? `<span class="tariff-price-old">${price.toFixed(2)} ${currencyConfig.symbol}</span>${finalPrice.toFixed(2)} ${currencyConfig.symbol}`
                        : `${price.toFixed(2)} ${currencyConfig.symbol}`;
                    const tariffId = tariff.id || tariff.tariff_id;
                    const isSelected = selectedTariffId === tariffId;
                    if (!tariffId) {
                        console.error('Tariff без ID:', tariff);
                        return '';
                    }
                    const bonusHtml = Number(tariff.bonus_days) > 0 
                        ? `<div style="font-size: 11px; color: var(--accent-primary); margin-top: 2px;">+${tariff.bonus_days} ${t('daysWord')}</div>` 
                        : '';
                    return `
                        <div class="tariff-card ${isSelected ? 'selected' : ''}" onclick="selectTariff(${tariffId})" style="margin-bottom: 8px; cursor: pointer;">
                            <div class="tariff-info">
                                <div class="tariff-name">${tariff.name || `${tariff.duration_days} ${t('daysWord')}`}</div>
                                <div class="tariff-duration">${tariff.duration_days} ${t('daysWord')}${bonusHtml}</div>
                            </div>
                            <div class="tariff-price">${priceDisplay}</div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            });

            tariffsModalList.innerHTML = html || `<div class="error">${t('tariffsNotFound')}</div>`;
            modal.classList.add('active');
        }

        function closeTariffsModal() {
            document.getElementById('tariffsModal').classList.remove('active');
        }

        function openTariffDetailsModal(tierCode) {
            const modal = document.getElementById('tariffDetailsModal');
            const content = document.getElementById('tariffDetailsContent');
            const title = document.getElementById('tariffDetailsTitle');
            
            if (!modal || !content) return;
            
            // Находим тарифы этого tier
            const tierTariffs = tariffs.filter(t => getTariffTier(t) === tierCode);
            if (tierTariffs.length === 0) return;
            
            // Получаем название tier
            const level = tariffLevels.find(l => l.code === tierCode);
            const tierName = level?.name || tierCode;
            
            // Получаем валюту
            const currency = currentCurrency || userData?.preferred_currency || 'uah';
            const currencyMap = {
                'uah': { field: 'price_uah', symbol: '₴' },
                'rub': { field: 'price_rub', symbol: '₽' },
                'usd': { field: 'price_usd', symbol: '$' }
            };
            const currencyConfig = currencyMap[currency] || currencyMap['uah'];
            
            // Получаем функции tier
            const features = renderTierFeatures(tierCode);
            
            // Сортируем тарифы по длительности
            tierTariffs.sort((a, b) => (a.duration_days || 0) - (b.duration_days || 0));
            
            // Создаем HTML для деталей (лимиты считаем для каждого тарифа отдельно)
            let html = `
                <div style="margin-bottom: 20px;">
                    ${features}
                </div>
                <div style="margin-bottom: 8px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Доступные тарифы:</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
            `;
            
            tierTariffs.forEach(tariff => {
                const price = Number(tariff[currencyConfig.field]) || 0;
                const finalPrice = getFinalTariffPrice(price);
                const hasDiscount = appliedPromo && finalPrice < price;
                const tariffId = tariff.id || tariff.tariff_id;
                const bonusDays = Number(tariff.bonus_days) || 0;
                const days = tariff.duration_days || 0;
                
                // Лимиты этого конкретного тарифа (трафик и устройства) — читаем оба формата полей
                const trafficLimitBytes = Number(tariff.traffic_limit_bytes ?? tariff.trafficLimitBytes ?? 0) || 0;
                const hwRaw = tariff.hwid_device_limit ?? tariff.hwidDeviceLimit;
                let deviceLimitNum = null;
                if (hwRaw !== null && hwRaw !== undefined && hwRaw !== '') {
                    const num = Number(hwRaw);
                    if (!isNaN(num) && num >= 0) deviceLimitNum = num;
                }
                let trafficLabel = '∞';
                if (trafficLimitBytes > 0) {
                    trafficLabel = (trafficLimitBytes / (1024 ** 3)).toFixed(0) + ' GB';
                }
                const deviceLabel = (deviceLimitNum !== null && deviceLimitNum > 0)
                    ? (deviceLimitNum + ' устр.')
                    : '∞';
                
                // Форматируем описание длительности
                let durationDescription = '';
                if (days === 14) {
                    durationDescription = '2 недели';
                } else if (days === 30) {
                    durationDescription = '1 месяц';
                } else if (days === 60) {
                    durationDescription = '2 месяца';
                } else if (days === 90) {
                    durationDescription = '3 месяца';
                } else if (days === 180) {
                    durationDescription = '6 месяцев';
                } else if (days === 360 || days === 365) {
                    durationDescription = '1 год';
                } else if (days === 720 || days === 730) {
                    durationDescription = '2 года';
                } else if (days >= 7 && days < 30) {
                    const weeks = Math.round(days / 7);
                    durationDescription = `${weeks} ${weeks === 1 ? 'неделя' : weeks < 5 ? 'недели' : 'недель'}`;
                } else if (days >= 30 && days < 365) {
                    const months = Math.round(days / 30);
                    durationDescription = `${months} ${months === 1 ? 'месяц' : months < 5 ? 'месяца' : 'месяцев'}`;
                } else if (days >= 365) {
                    const years = Math.round(days / 365);
                    durationDescription = `${years} ${years === 1 ? 'год' : years < 5 ? 'года' : 'лет'}`;
                }
                
                const priceDisplay = hasDiscount
                    ? `<span class="tariff-price-old">${price.toFixed(2)} ${currencyConfig.symbol}</span>${finalPrice.toFixed(2)} ${currencyConfig.symbol}`
                    : `${price.toFixed(2)} ${currencyConfig.symbol}`;
                const durationLine = days + ' ' + t('daysWord') + (bonusDays > 0 ? ' <span style="color: var(--accent-primary); font-size: 12px; font-weight: 600;">+' + bonusDays + ' ' + t('daysWord') + '</span>' : '');
                html += `
                    <div class="tariff-detail-option" onclick="selectTariff(${tariffId})" role="button" tabindex="0">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div class="option-duration">${durationLine}</div>
                                ${durationDescription ? `<div class="option-period">${durationDescription}</div>` : ''}
                                <div class="option-limits">Трафик: ${escapeHtml(trafficLabel)} · Устр.: ${escapeHtml(deviceLabel)}</div>
                            </div>
                            <div class="option-price">${priceDisplay}</div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            title.textContent = escapeHtml(tierName);
            modal.classList.add('active');
        }
        
        function closeTariffDetailsModal() {
            const modal = document.getElementById('tariffDetailsModal');
            if (modal) modal.classList.remove('active');
        }
        
        function selectTariff(tariffId) {
            console.log('Выбран тариф:', tariffId);
            if (!tariffId) {
                console.error('Tariff ID не передан');
                return;
            }
            selectedTariffId = tariffId;
            selectedOptionId = null;
            // Закрываем модальное окно деталей
            closeTariffDetailsModal();
            // Открываем модальное окно оплаты
            openPaymentModal();
        }

        function openPaymentModal() {
            if (!selectedTariffId && !selectedOptionId) return;

            const modal = document.getElementById('paymentModal');
            const paymentMethodsList = document.getElementById('paymentMethodsList');

            const paymentNames = {
                'crystalpay': '<svg class="icon"><use href="#icon-credit-card"/></svg> CrystalPay',
                'heleket': '<svg class="icon"><use href="#icon-shield"/></svg> Heleket',
                'yookassa': '<svg class="icon"><use href="#icon-credit-card"/></svg> YooKassa',
                'platega': '<svg class="icon"><use href="#icon-credit-card"/></svg> Platega',
                'platega_mir': '<svg class="icon"><use href="#icon-credit-card"/></svg> Карты МИР',
                'mulenpay': '<svg class="icon"><use href="#icon-credit-card"/></svg> Mulenpay',
                'urlpay': '<svg class="icon"><use href="#icon-credit-card"/></svg> UrlPay',
                'telegram_stars': '<svg class="icon"><use href="#icon-star"/></svg> Telegram Stars',
                'monobank': '<svg class="icon"><use href="#icon-credit-card"/></svg> Monobank',
                'btcpayserver': '<svg class="icon"><use href="#icon-shield"/></svg> BTCPayServer',
                'tribute': '<svg class="icon"><use href="#icon-credit-card"/></svg> Tribute',
                'robokassa': '<svg class="icon"><use href="#icon-credit-card"/></svg> Robokassa',
                'freekassa': '<svg class="icon"><use href="#icon-credit-card"/></svg> Freekassa',
                'kassa_ai': '<svg class="icon"><use href="#icon-credit-card"/></svg> Kassa AI'
            };

            let html = '';
            
            // Добавляем кнопку оплаты с баланса для тарифов и опций
            if (userData && userData.balance > 0 && (selectedTariffId || selectedOptionId)) {
                const currency = userData.preferred_currency || 'uah';
                const currencySymbol = currency === 'uah' ? '₴' : currency === 'rub' ? '₽' : '$';
                let finalPrice = 0;
                let canAfford = false;
                
                if (selectedTariffId) {
                    // Для тарифов
                    const selectedTariff = tariffs.find(t => (t.id || t.tariff_id) === selectedTariffId);
                    if (selectedTariff) {
                        const priceMap = {
                            uah: selectedTariff.price_uah,
                            rub: selectedTariff.price_rub,
                            usd: selectedTariff.price_usd
                        };
                        const tariffPrice = priceMap[currency] || priceMap.uah;
                        finalPrice = tariffPrice;
                        if (appliedPromo) {
                            if (appliedPromo.type === 'PERCENT') {
                                finalPrice = tariffPrice * (1 - appliedPromo.value / 100);
                            } else if (appliedPromo.type === 'FIXED') {
                                finalPrice = Math.max(0, tariffPrice - appliedPromo.value);
                            }
                        }
                        // Упрощенная проверка баланса (баланс в USD, конвертируем примерно)
                        const balanceInCurrency = currency === 'uah' ? userData.balance * 40 : 
                                                  currency === 'rub' ? userData.balance * 100 : 
                                                  userData.balance;
                        canAfford = balanceInCurrency >= finalPrice;
                    }
                } else if (selectedOptionId) {
                    // Для опций
                    const option = [...(purchaseOptions.traffic || []), ...(purchaseOptions.devices || []), ...(purchaseOptions.squad || [])].find(o => o.id === selectedOptionId);
                    if (option) {
                        const priceMap = {
                            uah: option.price_uah || 0,
                            rub: option.price_rub || 0,
                            usd: option.price_usd || 0
                        };
                        finalPrice = priceMap[currency] || priceMap.uah;
                        // Упрощенная проверка баланса (баланс в USD, конвертируем примерно)
                        const balanceInCurrency = currency === 'uah' ? userData.balance * 40 : 
                                                  currency === 'rub' ? userData.balance * 100 : 
                                                  userData.balance;
                        canAfford = balanceInCurrency >= finalPrice;
                    }
                }
                
                if (finalPrice > 0) {
                    html += `
                        <div class="payment-method" onclick="${canAfford ? "createPayment('balance')" : ''}" style="background: ${canAfford ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.1)'}; color: ${canAfford ? 'var(--accent-green)' : 'var(--accent-red)'}; border-color: ${canAfford ? 'var(--accent-green)' : 'var(--accent-red)'}; ${!canAfford ? 'cursor: not-allowed; opacity: 0.7;' : ''}">
                            <svg class="icon"><use href="#icon-wallet"/></svg>
                            <span>Оплатить с баланса (${finalPrice.toFixed(2)} ${currencySymbol})${!canAfford ? ' — Недостаточно средств' : ''}</span>
                        </div>
                    `;
                }
            }
            
            // Добавляем остальные способы оплаты
            html += paymentMethods.map(method => {
                const methodName = paymentNames[method.id] || method.name || method.id;
                return `
                    <div class="payment-method" onclick="createPayment('${method.id}')">
                        ${methodName}
                    </div>
                `;
            }).join('');

            paymentMethodsList.innerHTML = html || '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Нет доступных способов оплаты</div>';

            modal.classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function openSupportModal() {
            const modal = document.getElementById('supportModal');
            if (!modal) return;
            modal.classList.add('active');
            loadTickets();
        }

        function closeSupportModal() {
            const modal = document.getElementById('supportModal');
            if (modal) modal.classList.remove('active');
        }

        async function handleBalanceTopup(event) {
            event.preventDefault();
            const amountInput = document.getElementById('balanceAmount');
            const statusDiv = document.getElementById('balanceTopupStatus');
            const btn = document.getElementById('balanceTopupBtn');
            const paymentMethodSelect = document.getElementById('topupPaymentMethod');
            
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) {
                statusDiv.textContent = 'Введите корректную сумму';
                statusDiv.style.color = 'var(--accent-red)';
                return;
            }
            
            const paymentMethod = paymentMethodSelect.value;
            if (!paymentMethod) {
                statusDiv.textContent = 'Выберите способ оплаты';
                statusDiv.style.color = 'var(--accent-red)';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Создание платежа...';
            statusDiv.textContent = '';
            
            try {
                const initData = tg.initData || '';
                const telegramId = getUserFromInitData(initData);
                
                if (!telegramId) {
                    throw new Error('Ошибка авторизации');
                }
                
                // Получаем токен
                const tokenResponse = await fetch('/api/bot/get-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error('Ошибка получения токена');
                }
                
                const tokenData = await tokenResponse.json();
                const token = tokenData.token;
                
                // Создаем платеж для пополнения баланса
                const response = await fetch('/api/client/create-payment', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tariff_id: null,
                        amount: amount,
                        currency: currentCurrency || userData?.preferred_currency || 'uah',
                        payment_provider: paymentMethod,
                        source: 'miniapp'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Ошибка создания платежа');
                }
                
                if (data.payment_url) {
                    // Для Telegram Stars используем openInvoice
                    if (paymentMethod === 'telegram_stars' && tg.openInvoice) {
                        tg.openInvoice(data.payment_url, (status) => {
                            if (status === 'paid') {
                                tg.showAlert('✅ Платеж успешно выполнен!');
                                loadProfile();
                            } else if (status === 'failed') {
                                statusDiv.textContent = 'Оплата не удалась';
                                statusDiv.style.color = 'var(--accent-red)';
                            }
                        });
                    } else {
                        tg.openLink(data.payment_url);
                    }
                    amountInput.value = '';
                    statusDiv.textContent = 'Перенаправление на оплату...';
                    statusDiv.style.color = 'var(--accent-green)';
                } else {
                    throw new Error('Не получена ссылка на оплату');
                }
            } catch (error) {
                statusDiv.textContent = error.message || 'Ошибка пополнения баланса';
                statusDiv.style.color = 'var(--accent-red)';
            } finally {
                btn.disabled = false;
                btn.textContent = '💳 Пополнить баланс';
            }
        }

        async function createPayment(paymentMethod) {
            if (!selectedTariffId && !selectedOptionId) return;

            // Покупка опции (traffic/devices/squad)
            if (selectedOptionId) {
                try {
                    const initData = tg.initData || '';
                    if (!initData) throw new Error('Ошибка авторизации');

                    // Оплата опций с баланса обрабатывается так же, как и для тарифов

                    const payload = {
                        option_id: selectedOptionId,
                        payment_provider: paymentMethod,
                        currency: currentCurrency || userData?.preferred_currency || 'uah'
                    };
                    if (selectedConfigId) payload.config_id = selectedConfigId;

                    const response = await fetch('/miniapp/options/purchase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData, ...payload })
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data?.detail?.message || data?.message || 'Ошибка создания платежа');
                    }

                    closePaymentModal();
                    selectedOptionId = null;

                    // Оплата с баланса — успех без payment_url
                    if (paymentMethod === 'balance' && (data.success === true || (data.payment_url == null && response.ok))) {
                        tg.showAlert('✅ Опция успешно приобретена!');
                        loadProfile();
                        purchaseOptionsLoaded = false;
                        return;
                    }

                    if (data.payment_url) {
                        if (paymentMethod === 'telegram_stars' && tg.openInvoice) {
                            tg.openInvoice(data.payment_url, (status) => {
                                if (status === 'paid') {
                                    tg.showAlert('✅ Платеж успешно выполнен!');
                                    loadProfile();
                                    purchaseOptionsLoaded = false;
                                } else if (status === 'failed') {
                                    tg.showAlert('❌ Оплата не удалась');
                                }
                            });
                        } else {
                            tg.openLink(data.payment_url);
                        }
                    } else {
                        throw new Error('Не получена ссылка на оплату');
                    }
                } catch (e) {
                    console.error('Option payment error', e);
                    tg.showAlert((e && e.message) ? e.message : 'Ошибка оплаты');
                }
                return;
            }

            // Если оплата с баланса
            if (paymentMethod === 'balance') {
                try {
                    const initData = tg.initData || '';
                    const telegramId = getUserFromInitData(initData);
                    
                    if (!telegramId) {
                        throw new Error('Ошибка авторизации');
                    }
                    
                    // Получаем токен
                    const tokenResponse = await fetch('/api/bot/get-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegram_id: telegramId })
                    });
                    
                    if (!tokenResponse.ok) {
                        throw new Error('Ошибка получения токена');
                    }
                    
                    const tokenData = await tokenResponse.json();
                    const token = tokenData.token;
                    
                    // Если это опция, используем endpoint для опций
                    if (selectedOptionId) {
                        const currency = currentCurrency || userData?.preferred_currency || 'uah';
                        const payload = {
                            option_id: selectedOptionId,
                            payment_provider: 'balance',
                            currency: currency
                        };
                        if (selectedConfigId) payload.config_id = selectedConfigId;
                        
                        const response = await fetch('/api/client/create-option-payment', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        const data = await response.json().catch(() => ({}));
                        
                        if (response.ok && (data.payment_url === null || data.success === true)) {
                            // Оплата прошла успешно
                            tg.showAlert('✅ Опция успешно приобретена!');
                            closePaymentModal();
                            selectedOptionId = null;
                            loadProfile();
                            purchaseOptionsLoaded = false;
                            return;
                        } else {
                            throw new Error(data?.message || 'Ошибка оплаты опции с баланса');
                        }
                    }
                    
                    // Если это тариф, используем endpoint для тарифов
                    const payload = {
                        tariff_id: selectedTariffId
                    };
                    
                    // Добавляем config_id, если выбран конфиг для продления
                    if (selectedConfigId) {
                        payload.config_id = selectedConfigId;
                    }
                    
                    // Добавляем флаг создания нового конфига, если установлен
                    if (createNewConfig) {
                        payload.create_new_config = true;
                    }
                    
                    // Добавляем промокод, если он применен (PERCENT или FIXED)
                    if (appliedPromo && (appliedPromo.type === 'PERCENT' || appliedPromo.type === 'FIXED')) {
                        payload.promo_code = appliedPromo.code;
                    }
                    
                    const response = await fetch('/api/client/purchase-with-balance', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        tg.showAlert('Тариф успешно активирован!');
                        closePaymentModal();
                        // Перезагружаем данные
                        setTimeout(() => {
                            loadData();
                        }, 1000);
                    } else {
                        tg.showAlert(data.message || 'Ошибка покупки тарифа');
                    }
                } catch (error) {
                    console.error('Ошибка покупки с баланса:', error);
                    tg.showAlert('Ошибка покупки тарифа');
                }
                return;
            }

            try {
                const initData = tg.initData || '';
                const payload = {
                    initData,
                    tariff_id: selectedTariffId,
                    payment_provider: paymentMethod,
                    currency: currentCurrency || userData?.preferred_currency || 'uah'
                };
                
                // Добавляем config_id, если выбран конфиг для продления
                if (selectedConfigId) {
                    payload.config_id = selectedConfigId;
                }
                
                // Добавляем флаг создания нового конфига, если установлен
                if (createNewConfig) {
                    payload.create_new_config = true;
                }
                
                // Очищаем флаги после создания платежа
                if (selectedConfigId) {
                    selectedConfigId = null;
                }
                if (createNewConfig) {
                    createNewConfig = false;
                }
                
                // Добавляем промокод, если он применен (PERCENT или FIXED)
                if (appliedPromo && (appliedPromo.type === 'PERCENT' || appliedPromo.type === 'FIXED')) {
                    payload.promo_code = appliedPromo.code;
                }
                
                const response = await fetch('/miniapp/payments/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.payment_url) {
                    tg.openLink(data.payment_url);
                } else if (data.url) {
                    tg.openLink(data.url);
                } else {
                    tg.showAlert(t('errorPayment'));
                }

                closePaymentModal();
            } catch (error) {
                console.error('Ошибка создания платежа:', error);
                tg.showAlert('Ошибка создания платежа');
            }
        }

        // Закрытие модальных окон при клике вне их
        document.getElementById('tariffsModal').addEventListener('click', (e) => {
            if (e.target.id === 'tariffsModal') {
                closeTariffsModal();
            }
        });

        document.getElementById('paymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'paymentModal') {
                closePaymentModal();
            }
        });

        document.getElementById('supportModal').addEventListener('click', (e) => {
            if (e.target.id === 'supportModal') {
                closeSupportModal();
            }
        });

        // Функции для промокодов
        async function activatePromoCode() {
            const input = document.getElementById('promoCodeInput');
            const btn = document.getElementById('promoActivateBtn');
            const status = document.getElementById('promoStatus');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                status.innerHTML = `<span style="color: var(--danger);">${t('enterCode')}</span>`;
                status.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '...';
            status.innerHTML = '';
            status.style.display = 'none';
            
            try {
                const initData = tg.initData || '';
                const response = await fetch('/miniapp/promo-codes/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData, promo_code: code })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    status.innerHTML = `<span style="color: var(--success);">✓ ${data.message || t('promoActivated')}</span>`;
                    status.style.display = 'block';
                    status.className = 'status-message success';
                    input.value = '';
                    // Перезагружаем данные подписки
                    setTimeout(() => {
                        loadData();
                    }, 1500);
                } else {
                    const errorMsg = data.detail?.message || data.message || t('promoError');
                    status.innerHTML = `<span style="color: var(--danger);">✗ ${errorMsg}</span>`;
                    status.style.display = 'block';
                    status.className = 'status-message error';
                }
            } catch (error) {
                console.error('Ошибка активации промокода:', error);
                status.innerHTML = `<span style="color: var(--danger);">✗ ${t('promoError')}</span>`;
                status.style.display = 'block';
                status.className = 'status-message error';
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span id="promoOkBtn">${t('ok')}</span>`;
            }
        }

        // Функции для рефералки
        // Функция для загрузки пароля
        async function loadUserPassword() {
            try {
                const initData = tg.initData || '';
                const telegramId = getUserFromInitData(initData);
                
                if (!telegramId) {
                    console.log('Cannot load password: telegram_id not found');
                    const userPasswordEl = document.getElementById('userPassword');
                    if (userPasswordEl) {
                        userPasswordEl.textContent = t('notAvailable');
                    }
                    return;
                }
                
                const response = await fetch('/api/bot/get-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Got credentials from /api/bot/get-credentials:', data);
                    
                    const password = data.password || null;
                    const userPasswordEl = document.getElementById('userPassword');
                    
                    if (userPasswordEl) {
                        if (password) {
                            userPasswordEl.textContent = password;
                            // Обновляем userData
                            if (userData) {
                                userData.password = password;
                            }
                        } else {
                            userPasswordEl.textContent = t('notAvailable');
                        }
                    }
                } else {
                    console.error('Failed to fetch credentials:', response.status);
                    const userPasswordEl = document.getElementById('userPassword');
                    if (userPasswordEl) {
                        userPasswordEl.textContent = t('notAvailable');
                    }
                }
            } catch (error) {
                console.error('Error loading password:', error);
                const userPasswordEl = document.getElementById('userPassword');
                if (userPasswordEl) {
                    userPasswordEl.textContent = t('notAvailable');
                }
            }
        }

        async function loadServerDomain() {
            try {
                const response = await fetch('/api/public/server-domain');
                if (response.ok) {
                    const data = await response.json();
                    serverDomain = data.full_url || data.domain || '';
                    // Обновляем реферальную ссылку после загрузки домена
                    if (userData) {
                        updateReferralLink();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки домена:', error);
            }
        }

        async function updateReferralLink() {
            console.log('updateReferralLink called, userData:', userData);
            console.log('referral_code:', userData?.referral_code);
            console.log('serverDomain:', serverDomain);
            
            if (!userData) {
                console.log('userData is null');
                return;
            }
            
            // Проверяем разные варианты названия поля
            let referralCode = userData.referral_code || userData.referralCode || null;
            
            // Если referral_code не найден в userData, пробуем получить через API
            if (!referralCode) {
                console.log('referral_code not found in userData, trying to fetch from API...');
                try {
                    const initData = tg.initData || '';
                    const telegramId = getUserFromInitData(initData);
                    
                    if (telegramId) {
                        const tokenResponse = await fetch('/api/bot/get-token', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ telegram_id: telegramId })
                        });
                        
                        if (tokenResponse.ok) {
                            const tokenData = await tokenResponse.json();
                            const token = tokenData.token;
                            
                            // Получаем данные пользователя через API
                            const userResponse = await fetch('/api/client/me', {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            if (userResponse.ok) {
                                const userApiData = await userResponse.json();
                                console.log('Got user data from /api/client/me in updateReferralLink:', userApiData);
                                console.log('Full userApiData keys:', Object.keys(userApiData || {}));
                                
                                // Проверяем response обертку
                                const responseData = userApiData.response || userApiData;
                                console.log('responseData.referral_code:', responseData?.referral_code);
                                
                                referralCode = responseData.referral_code || responseData.referralCode || userApiData.referral_code || userApiData.referralCode || null;
                                console.log('Got referral_code from API:', referralCode);
                                
                                // Обновляем userData
                                if (referralCode && userData) {
                                    userData.referral_code = referralCode;
                                    console.log('Updated userData.referral_code:', userData.referral_code);
                                } else {
                                    console.log('referral_code is null or empty, cannot update userData');
                                }
                            } else {
                                console.error('Failed to fetch /api/client/me in updateReferralLink:', userResponse.status);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching referral_code from API:', error);
                }
            }
            
            const input = document.getElementById('referralLinkInput');
            const botInput = document.getElementById('referralBotLinkInput');
            
            if (!referralCode) {
                console.log('referral_code still not found after all attempts');
                console.log('This means the user does not have a referral_code in the database');
                console.log('The referral_code should be generated automatically when user is created');
                if (input) {
                    input.value = t('referralCodeNotFound');
                    input.style.color = 'var(--text-secondary)';
                    input.style.fontStyle = 'italic';
                }
                if (botInput) {
                    botInput.value = t('referralCodeNotFound');
                    botInput.style.color = 'var(--text-secondary)';
                    botInput.style.fontStyle = 'italic';
                }
                return;
            }
            
            // Обновляем ссылку на сайт
            if (input) {
                input.style.color = '';
                input.style.fontStyle = '';
                
                const baseUrl = serverDomain.startsWith('http') ? serverDomain : `https://${serverDomain}`;
                const referralLink = `${baseUrl}/register?ref=${referralCode}`;
                
                console.log('Generated referral link:', referralLink);
                input.value = referralLink;
                console.log('Referral link set to input');
            } else {
                console.log('referralLinkInput element not found');
            }
            
            // Обновляем ссылку на бота
            if (botInput && referralCode) {
                botInput.style.color = '';
                botInput.style.fontStyle = '';
                
                // Если botUsername еще не загружен, пробуем получить его
                if (!botUsername) {
                    // Пробуем получить из botConfig
                    if (botConfig.bot_username) {
                        botUsername = botConfig.bot_username;
                        if (botUsername.startsWith('@')) {
                            botUsername = botUsername.substring(1);
                        }
                    } else if (botConfig.bot_link_for_miniapp) {
                        const match = botConfig.bot_link_for_miniapp.match(/t\.me\/([^\/\?]+)/);
                        if (match) {
                            botUsername = match[1];
                        }
                    }
                }
                
                // Если все еще нет botUsername, используем дефолтное значение
                if (!botUsername) {
                    botUsername = ''; // Fallback (подставляется из API/конфига)
                }
                
                const botReferralLink = `https://t.me/${botUsername}?start=${referralCode}`;
                console.log('Generated bot referral link:', botReferralLink);
                botInput.value = botReferralLink;
            }
        }

        async function copyReferralLink() {
            const input = document.getElementById('referralLinkInput');
            const btn = document.getElementById('referralCopyBtn');
            
            if (!input || !input.value) return;
            
            try {
                await navigator.clipboard.writeText(input.value);
                const originalText = btn.textContent;
                btn.textContent = '✓';
                tg.showAlert(t('linkCopied'));
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Ошибка копирования:', error);
                tg.showAlert(t('errorCopy'));
            }
        }

        async function copyReferralBotLink() {
            const input = document.getElementById('referralBotLinkInput');
            const btn = document.getElementById('referralBotCopyBtn');
            
            if (!input || !input.value) return;
            
            try {
                await navigator.clipboard.writeText(input.value);
                const originalText = btn.textContent;
                btn.textContent = '✓';
                tg.showAlert(t('linkCopied'));
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } catch (error) {
                console.error('Ошибка копирования:', error);
                tg.showAlert(t('errorCopy'));
            }
        }

        // Функции для промокода в тарифах
        async function checkTariffPromoCode() {
            const input = document.getElementById('tariffPromoCodeInput');
            const btn = document.getElementById('tariffPromoCheckBtn');
            const status = document.getElementById('tariffPromoStatus');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                status.innerHTML = `<span style="color: var(--danger);">${t('enterPromoCode')}</span>`;
                status.style.display = 'block';
                status.className = 'status-message error';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '...';
            status.innerHTML = '';
            status.style.display = 'none';
            
            try {
                // Получаем токен через bot/get-token
                const initData = tg.initData || '';
                const telegramId = getUserFromInitData(initData);
                
                if (!telegramId) {
                    status.innerHTML = `<span style="color: var(--danger);">✗ ${t('errorAuth')}</span>`;
                    status.style.display = 'block';
                    status.className = 'status-message error';
                    return;
                }
                
                const tokenResponse = await fetch('/api/bot/get-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(t('errorGettingToken'));
                }
                
                const tokenData = await tokenResponse.json();
                const token = tokenData.token;
                
                // Проверяем промокод
                const checkResponse = await fetch('/api/client/check-promocode', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ promo_code: code })
                });
                
                const checkData = await checkResponse.json();
                
                if (checkResponse.ok && checkData.valid) {
                    if (checkData.promo_type === 'PERCENT' || checkData.promo_type === 'FIXED') {
                        appliedPromo = {
                            code: code,
                            type: checkData.promo_type,
                            value: checkData.value
                        };
                        const discountText = checkData.promo_type === 'PERCENT' 
                            ? `${checkData.value}%` 
                            : `${checkData.value} ${currentCurrency === 'uah' ? '₴' : currentCurrency === 'rub' ? '₽' : '$'}`;
                        status.innerHTML = `<span style="color: var(--success);">✓ ${t('promoAppliedWithDiscount')} ${code}: ${discountText}</span>`;
                        status.style.display = 'block';
                        status.className = 'status-message success';
                        // Перерисовываем тарифы с учетом промокода
                        if (tariffs.length > 0) {
                            renderTariffs();
                        }
                    } else {
                        status.innerHTML = `<span style="color: var(--warning);">⚠ ${t('promoDaysActivate')}</span>`;
                        status.style.display = 'block';
                        status.className = 'status-message';
                        appliedPromo = null;
                    }
                } else {
                    const errorMsg = checkData.message || t('promoInvalid');
                    status.innerHTML = `<span style="color: var(--danger);">✗ ${errorMsg}</span>`;
                    status.style.display = 'block';
                    status.className = 'status-message error';
                    appliedPromo = null;
                }
            } catch (error) {
                console.error('Ошибка проверки промокода:', error);
                status.innerHTML = `<span style="color: var(--danger);">✗ ${t('errorPromoCheck')}</span>`;
                status.style.display = 'block';
                status.className = 'status-message error';
                appliedPromo = null;
            } finally {
                btn.disabled = false;
                btn.textContent = t('apply');
            }
        }

        function getUserFromInitData(initData) {
            try {
                if (!initData) return null;
                const parsed = new URLSearchParams(initData);
                const userStr = parsed.get('user');
                if (!userStr) return null;
                const user = JSON.parse(decodeURIComponent(userStr));
                return user.id || null;
            } catch (error) {
                console.error('Ошибка парсинга initData:', error);
                return null;
            }
        }

        // Функции для тикетов
        async function loadTickets() {
            try {
                const initData = tg.initData || '';
                const telegramId = getUserFromInitData(initData);
                
                if (!telegramId) {
                    document.getElementById('ticketsList').innerHTML = `<div class="error">${t('errorAuth')}</div>`;
                    return;
                }
                
                const tokenResponse = await fetch('/api/bot/get-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(t('errorGettingToken'));
                }
                
                const tokenData = await tokenResponse.json();
                const token = tokenData.token;
                
                const response = await fetch('/api/client/support-tickets', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    tickets = await response.json();
                    renderTickets();
                } else {
                    document.getElementById('ticketsList').innerHTML = `<div class="error">${t('errorLoadingTickets')}</div>`;
                }
            } catch (error) {
                console.error('Ошибка загрузки тикетов:', error);
                document.getElementById('ticketsList').innerHTML = '<div class="error">Ошибка загрузки тикетов</div>';
            }
        }

        function renderTickets() {
            const ticketsList = document.getElementById('ticketsList');
            
            if (tickets.length === 0) {
                ticketsList.innerHTML = `<div class="text-center text-muted" style="padding: 24px;">${t('noTickets')}</div>`;
                return;
            }
            
            ticketsList.innerHTML = tickets.map(ticket => {
                const isOpen = ticket.status !== 'CLOSED';
                const statusText = ticket.status === 'CLOSED' ? t('closed') : t('open');
                const date = new Date(ticket.created_at).toLocaleDateString('ru-RU');
                return `
                    <div class="ticket-card" onclick="openTicket(${ticket.id})">
                        <div class="ticket-header">
                            <span class="ticket-id">${t('ticketNum')}${ticket.id}</span>
                            <span class="status-badge ${isOpen ? 'status-active' : 'status-inactive'}">
                                <span class="status-dot ${isOpen ? 'online' : 'offline'}"></span>
                                ${statusText}
                            </span>
                        </div>
                        <div class="ticket-subject">${ticket.subject || 'Без темы'}</div>
                        <div class="ticket-date">${date}</div>
                    </div>
                `;
            }).join('');
        }

        async function openTicket(ticketId) {
            // Открываем тикет в новой странице или модальном окне
            // Пока просто показываем алерт
            tg.showAlert(`${t('ticketNum')}${ticketId}\n${t('viewTicketOnSite')}`);
        }

        async function createTicket() {
            const subjectInput = document.getElementById('ticketSubject');
            const messageInput = document.getElementById('ticketMessage');
            const subject = subjectInput.value.trim();
            const message = messageInput.value.trim();
            
            if (!subject || !message) {
                tg.showAlert(t('fillAllFields'));
                return;
            }
            
            try {
                const initData = tg.initData || '';
                const telegramId = getUserFromInitData(initData);
                
                if (!telegramId) {
                    tg.showAlert(t('errorAuth'));
                    return;
                }
                
                const tokenResponse = await fetch('/api/bot/get-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(t('errorGettingToken'));
                }
                
                const tokenData = await tokenResponse.json();
                const token = tokenData.token;
                
                const response = await fetch('/api/client/support-tickets', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subject, message })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    tg.showAlert(t('ticketCreated'));
                    subjectInput.value = '';
                    messageInput.value = '';
                    // Перезагружаем список тикетов
                    loadTickets();
                } else {
                    tg.showAlert(data.message || t('errorCreatingTicket'));
                }
            } catch (error) {
                console.error('Ошибка создания тикета:', error);
                tg.showAlert(t('errorCreatingTicket'));
            }
        }

        // Функции для изменения валюты и языка
        async function changeCurrency() {
            const select = document.getElementById('currencySelect');
            const newCurrency = select.value;
            
            if (newCurrency === currentCurrency) return;
            
            // Проверяем, что валюта активна
            if (!activeCurrencies.includes(newCurrency)) {
                console.warn('Выбранная валюта не активна:', newCurrency);
                return;
            }
            
            currentCurrency = newCurrency;
            
            // Сохраняем в localStorage для следующего открытия
            localStorage.setItem('preferredCurrency', newCurrency);
            
            // Сохраняем настройки на сервере
            await saveSettings({ currency: newCurrency });
            
            // Обновляем userData
            if (userData) {
                userData.preferred_currency = newCurrency;
            }
            
            // Обновляем отображение тарифов
            if (tariffs.length > 0) {
                renderTariffs();
            }
            
            // Обновляем баланс с новой валютой
            updateSubscriptionInfo();
            
            tg.showAlert(t('currencyChanged'));
        }

        async function changeLanguage() {
            const select = document.getElementById('languageSelect');
            const newLanguage = select.value;
            
            if (newLanguage === currentLanguage) return;
            
            // Проверяем, что язык активен
            if (!activeLanguages.includes(newLanguage)) {
                console.warn('Выбранный язык не активен:', newLanguage);
                return;
            }
            
            currentLanguage = newLanguage;
            
            // Сохраняем настройки
            await saveSettings({ lang: newLanguage });
            
            // Обновляем userData
            if (userData) {
                userData.preferred_lang = newLanguage;
            }
            
            // Обновляем интерфейс
            updateLanguageUI();
            
            // Обновляем атрибут lang у html
            document.documentElement.lang = newLanguage;
            
            const langMessages = {
                ru: 'Язык изменен',
                ua: 'Мову змінено',
                en: 'Language changed',
                cn: '语言已更改'
            };
            
            tg.showAlert(t('languageChanged'));
        }

        async function saveSettings(settings) {
            try {
                const initData = tg.initData || '';
                const telegramId = getUserFromInitData(initData);
                
                if (!telegramId) {
                    console.error('Не удалось получить telegram_id');
                    return;
                }
                
                const tokenResponse = await fetch('/api/bot/get-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(t('errorGettingToken'));
                }
                
                const tokenData = await tokenResponse.json();
                const token = tokenData.token;
                
                const response = await fetch('/api/client/settings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Ошибка сохранения настроек:', errorData);
                }
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
            }
        }

        // Загрузка данных при инициализации
        loadServerDomain();
        loadData();
        
        // Обновляем переключатель темы после загрузки DOM
        setTimeout(() => {
            updateThemeToggle();
        }, 100);
        
        // Делаем функции доступными глобально для onclick
        window.toggleTheme = toggleTheme;
    </script>

    <!-- Floating Connect Button (hidden, button in status block is used) -->
    <button id="floatingConnectBtn" class="btn floating-button hidden" onclick="handleConnectClick(event)" style="display: none;">
        <svg class="icon"><use href="#icon-rocket"/></svg>
        Подключиться
    </button>
</body>
</html>

